<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¶åƒå¡ç‰‡ç³»çµ±</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary-color: #ec4899;
      --primary-dark: #db2777;
      --primary-light: #f472b6;
      --secondary-color: #8b5cf6;
      --accent-color: #06b6d4;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #06b6d4;
      --bg-primary: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 50%, #f0f9ff 100%);
      --bg-secondary: #ffffff;
      --bg-card: rgba(255, 255, 255, 0.8);
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: rgba(236, 72, 153, 0.2);
      --shadow-primary: 0 25px 50px -12px rgba(236, 72, 153, 0.4);
      --shadow-card: 0 10px 25px -3px rgba(236, 72, 153, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient-primary: linear-gradient(135deg, #ec4899 0%, #db2777 50%, #be185d 100%);
      --gradient-secondary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
      --gradient-accent: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-bg: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 25%, #f0f9ff 50%, #ecfeff 75%, #fdf2f8 100%);
      --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      background-attachment: fixed;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-bg);
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(236, 72, 153, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 90% 70%, rgba(245, 158, 11, 0.1) 0%, transparent 40%);
      z-index: -1;
    }

    .header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(236, 72, 153, 0.2);
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(236, 72, 153, 0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -0.05em;
      text-shadow: 0 4px 20px rgba(236, 72, 153, 0.3);
      font-family: 'Poppins', sans-serif;
    }

    h1::after {
      content: 'âœ¨';
      margin-left: 0.5rem;
      font-size: 2rem;
      filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.5));
    }

    .wallet-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .wallet-balance-btn {
      background: var(--gradient-accent);
      border: none;
      cursor: pointer;
      padding: 0.75rem;
      border-radius: 20px;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-card);
    }

    .wallet-balance-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 30px rgba(6, 182, 212, 0.4);
    }

    .wallet-balance-btn img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .wallet-connect-card {
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 2.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .wallet-connect-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .wallet-connect-card::after {
      content: 'ğŸ’';
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 1.5rem;
      opacity: 0.3;
    }

    .connect-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1.25rem 2.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: var(--shadow-card);
    }

    .connect-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .connect-btn:hover::before {
      left: 100%;
    }

    .connect-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 15px 35px rgba(236, 72, 153, 0.4);
    }

    .connect-btn:active {
      transform: translateY(0);
    }

    .tabs {
      display: flex;
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 0.75rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      overflow-x: auto;
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-card);
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-radius: 20px;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
      color: var(--text-secondary);
      position: relative;
      font-family: 'Poppins', sans-serif;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(236, 72, 153, 0.1);
      transform: translateY(-2px);
    }

    .tab.active {
      background: var(--gradient-primary);
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
      transform: translateY(-2px);
    }

    .tab.active::after {
      content: 'â­';
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 2.5rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-primary);
      border-color: var(--primary-color);
    }

    h2,
    h3 {
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
    }

    h2 {
      font-size: 1.75rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }

    h2::after {
      content: 'ğŸ’–';
      margin-left: 0.5rem;
      font-size: 1.2rem;
      filter: drop-shadow(0 0 8px rgba(236, 72, 153, 0.4));
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    input,
    select {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: var(--bg-secondary);
    }

    input::placeholder {
      color: var(--text-secondary);
    }

    button {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1rem 1.75rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Poppins', sans-serif;
      box-shadow: var(--shadow-card);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 25px rgba(236, 72, 153, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--gradient-secondary);
    }

    .btn-secondary:hover {
      box-shadow: 0 12px 25px rgba(139, 92, 246, 0.4);
    }

    .btn-success {
      background: var(--gradient-success);
    }

    .btn-success:hover {
      box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .btn-danger:hover {
      box-shadow: 0 12px 25px rgba(239, 68, 68, 0.4);
    }

    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 500;
      border-left: 4px solid;
    }

    .success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border-color: var(--error-color);
    }

    .info {
      background: rgba(59, 130, 246, 0.1);
      color: var(--info-color);
      border-color: var(--info-color);
    }

    .warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border-color: var(--warning-color);
    }

    /* Card Display Styles */
    .idol-card {
      background: var(--gradient-card);
      border-radius: 25px;
      overflow: hidden;
      box-shadow: var(--shadow-card);
      transition: all 0.4s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .idol-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .idol-card:hover::before {
      opacity: 1;
    }

    .idol-card:hover {
      transform: translateY(-10px) rotateY(3deg) scale(1.02);
      box-shadow: var(--shadow-primary);
      border-color: var(--primary-color);
    }

    .idol-card-image {
      width: 100%;
      height: 300px;
      background: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 1.2rem;
      position: relative;
      overflow: hidden;
    }

    .idol-card-image::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(236, 72, 153, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .idol-card:hover .idol-card-image::after {
      opacity: 1;
    }

    .idol-card-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: white;
      border-radius: 15px 15px 0 0;
      position: relative;
      z-index: 2;
    }

    .idol-card-image .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-secondary);
      font-size: 1rem;
      padding: 2rem;
      font-family: 'Poppins', sans-serif;
      position: relative;
      z-index: 2;
    }

    .idol-card-content {
      padding: 2rem;
      position: relative;
      z-index: 2;
    }

    .idol-card-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      font-family: 'Poppins', sans-serif;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .idol-card-info {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      font-weight: 500;
      line-height: 1.8;
    }

    .idol-card-price {
      font-size: 1.75rem;
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1.5rem;
      font-family: 'Poppins', sans-serif;
      position: relative;
    }

    .idol-card-price::before {
      content: 'ğŸ’°';
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }

    .idol-card-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .idol-card-actions button {
      flex: 1;
      min-width: 140px;
      font-size: 0.9rem;
      padding: 0.875rem 1.25rem;
    }


    /* Transaction History Styles */
    .transaction-history {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(236, 72, 153, 0.2);
    }

    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      background: linear-gradient(90deg, rgba(236, 72, 153, 0.02) 0%, transparent 100%);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .transaction-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .transaction-date {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .transaction-action {
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'Poppins', sans-serif;
    }

    .transaction-amount {
      font-weight: 700;
      color: var(--primary-color);
      font-family: 'Poppins', sans-serif;
    }

    /* Market Grid */
    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    /* Table Styles */
    .modern-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--gradient-card);
      border-radius: 20px;
      overflow: hidden;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
    }

    .modern-table th {
      background: var(--gradient-primary);
      color: white;
      padding: 1.25rem;
      text-align: left;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-family: 'Poppins', sans-serif;
      position: relative;
    }

    .modern-table th::after {
      content: 'âœ¨';
      position: absolute;
      right: 1rem;
      opacity: 0.7;
    }

    .modern-table td {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      color: var(--text-primary);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.5);
    }

    .modern-table tr:hover td {
      background: rgba(236, 72, 153, 0.05);
      transform: scale(1.01);
      transition: all 0.3s ease;
    }

    .modern-table tr:last-child td {
      border-bottom: none;
    }

    /* Trade Status Badges */
    .trade-status {
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;

      white-space: nowrap;
      display: inline-block;
    }

    .trade-status::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .trade-status:hover::before {
      left: 100%;
    }

    .status-created {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      border-color: #06b6d4;
    }

    .status-buyer-signed {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: #f59e0b;
    }

    .status-seller-signed {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-color: #8b5cf6;
    }

    .status-completed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
    }

    /* Loading Animation */
    .loader {
      border: 4px solid rgba(236, 72, 153, 0.2);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite, pulse 2s ease-in-out infinite alternate;
      display: inline-block;
      margin-left: 0.75rem;
      vertical-align: middle;
      box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
      }

      100% {
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.6);
      }
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(236, 72, 153, 0.1);
      backdrop-filter: blur(15px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: var(--gradient-card);
      padding: 2.5rem;
      border-radius: 25px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-primary);
      backdrop-filter: blur(20px);
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      border-radius: 25px 25px 0 0;
    }

    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      background: rgba(236, 72, 153, 0.1);
      border: none;
      padding: 0.75rem;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--primary-color);
      background: rgba(236, 72, 153, 0.2);
      transform: scale(1.1) rotate(90deg);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .content-grid {
        grid-template-columns: 1fr;
      }

      .market-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 2.5rem;
      }

      .header-content {
        flex-direction: column;
        gap: 1.5rem;
      }

      .wallet-section {
        width: 100%;
        justify-content: center;
      }

      .tabs {
        overflow-x: auto;
        padding: 0.5rem;
      }

      .tab {
        padding: 0.875rem 1.25rem;
        font-size: 0.9rem;
      }

      .idol-card:hover {
        transform: translateY(-5px) scale(1.01);
      }

      .card {
        padding: 2rem;
      }

      .modal-content {
        padding: 2rem;
        margin: 1rem;
      }

      .idol-card-actions {
        flex-direction: column;
      }

      .idol-card-actions button {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 2rem;
      }

      .wallet-connect-card {
        padding: 2rem;
      }

      .card {
        padding: 1.5rem;
      }

      .idol-card-content {
        padding: 1.5rem;
      }

      .tab {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
      }
    }

    /* Hide elements initially */
    .tabs,
    .tab-content,
    .container .content-grid {
      display: none;
    }

    .tabs.show,
    .container .content-grid.show {
      display: flex;
    }

    .content-grid.show {
      display: grid;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-content">
      <h1>å¶åƒå¡ç‰‡ç³»çµ±</h1>
      <div class="wallet-section">
        <button id="walletBalanceBtn" class="wallet-balance-btn">
          <img src="./wallet.webp" alt="æŸ¥çœ‹éŒ¢åŒ…é¤˜é¡" onerror="this.style.display='none'">
        </button>
        <button id="connectWalletBtn" class="connect-btn">é€£æ¥éŒ¢åŒ…</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="wallet-connect-card">
      <h2>éŒ¢åŒ…é€£æ¥</h2>
      <div id="connection-status" class="status info">è«‹é€£æ¥æ‚¨çš„éŒ¢åŒ…ä»¥ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="purchase">ç™¼è¡Œå¡ç‰‡</div>
      <div class="tab" data-tab="myCards">æˆ‘çš„å¡ç‰‡</div>
      <div class="tab" data-tab="market">å¸‚å ´äº¤æ˜“</div>
      <div class="tab" data-tab="admin">ç®¡ç†åŠŸèƒ½</div>
      <div class="tab" data-tab="history">éå¾€äº¤æ˜“</div>
    </div>

    <div class="content-grid">
      <!-- è³¼è²·å¡ç‰‡ Tab -->
      <div id="purchase" class="tab-content active">
        <!-- å…¬å¸è§’è‰² -->
        <div class="role-content company-role">
          <div class="card">
            <h2>è¨­ç½®å¡ç‰‡è³‡è¨Šèˆ‡åƒ¹æ ¼</h2>
            <div class="form-group">
              <label class="form-label">å¶åƒåœ˜é«”åç¨±</label>
              <input type="text" id="idol-group" placeholder="ä¾‹å¦‚ï¼šBTS">
            </div>
            <div class="form-group">
              <label class="form-label">æˆå“¡å§“å</label>
              <input type="text" id="idol-member" placeholder="ä¾‹å¦‚ï¼šJungkook">
            </div>
            <div class="form-group">
              <label class="form-label">å¡ç‰‡ç·¨è™Ÿ</label>
              <input type="text" id="card-number" placeholder="ä¾‹å¦‚ï¼š001">
            </div>
            <div class="form-group">
              <label class="form-label">å¡ç‰‡ä¸Šæ¶åƒ¹ (ETH)</label>
              <input type="number" id="list-price" placeholder="0.001" step="0.001">
            </div>
            <div class="form-group">
              <label class="form-label">ç…§ç‰‡ URI</label>
              <input type="text" id="photo-uri" placeholder="ipfs://xxx æˆ– https://...">
            </div>
            <div class="form-group">
              <label class="form-label">åˆç´„å…§éƒ¨åƒ¹æ ¼ (ETH)</label>
              <input type="number" id="new-price" placeholder="0.001" step="0.001">
            </div>
            <div class="form-group">
              <label class="form-label">ç™¼è¡Œå¼µæ•¸</label>
              <input type="number" id="card-amount" placeholder="10">
            </div>
            <button id="set-price-btn" class="btn-success">è¨­ç½®å¡ç‰‡è³‡è¨Š</button>
            <div id="set-price-status"></div>
          </div>
        </div>

        <!-- æ™®é€šç”¨æˆ¶è§’è‰² -->
        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>å…¬å¸è²©å”®å¡ç‰‡</h2>
            <div id="available-cards-market" class="market-grid">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>è½‰å”®å¡ç‰‡å¸‚å ´</h2>
            <div id="resale-cards-market" class="market-grid">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ç¶å®šå¡ç‰‡ UID</h2>
            <div class="form-group">
              <label class="form-label">å¡ç‰‡ UID</label>
              <input type="text" id="card-uid" placeholder="è¼¸å…¥å¡ç‰‡ UID">
            </div>
            <button id="request-card-btn">è«‹æ±‚ç¶å®š</button>
            <div id="request-status"></div>
          </div>
        </div>

        <div id="purchase-status" class="card" style="margin-top: 2rem;"></div>
      </div>

      <!-- æˆ‘çš„å¡ç‰‡ Tab -->
      <div id="myCards" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>å¡ç‰‡ç™¼è¡Œçµ±è¨ˆ</h2>
            <div id="card-stats">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>æ“æœ‰å¡ç‰‡</h2>
            <div id="my-cards-list-first" class="market-grid">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content second-hand-role" style="display: none;">
          <div class="card">
            <h2>ä¸Šæ¶å¡ç‰‡</h2>
            <div id="my-cards-list-second" class="market-grid">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>å‰µå»ºäº¤æ˜“</h2>
            <div class="form-group">
              <label class="form-label">é¸æ“‡å¡ç‰‡</label>
              <select id="card-to-sell">
                <option value="">-- é¸æ“‡å¡ç‰‡ --</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">éŠ·å”®åƒ¹æ ¼ (ETH)</label>
              <input type="number" id="selling-price" placeholder="0.01" step="0.01">
            </div>
            <button id="resale-btn" class="btn-secondary">ä¸Šæ¶äºŒæ‰‹å¡ç‰‡</button>
            <div id="create-trade-status"></div>
          </div>
        </div>
      </div>

      <!-- å¸‚å ´äº¤æ˜“ Tab -->
      <div id="market" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>æ‰€æœ‰äº¤æ˜“æ¦‚è¦½</h2>
            <div id="all-trades-overview">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>å¯ç”¨äº¤æ˜“</h2>
            <div id="available-trades-first">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>æˆ‘çš„éŠ·å”®</h2>
            <div id="my-sales-first">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content second-hand-role" style="display: none;">
          <div class="card">
            <h2>å¯ç”¨äº¤æ˜“</h2>
            <div id="available-trades-second">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>æˆ‘çš„äº¤æ˜“ç®¡ç†</h2>
            <div id="my-trades-second">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†åŠŸèƒ½ Tab -->
      <div id="admin" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>å¯©æ‰¹å¡ç‰‡è«‹æ±‚</h2>
            <div id="pending-requests">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>äº¤æ˜“æ•¸æ“šåˆ†æ</h2>
            <div id="trade-analytics">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>ç„¡ç®¡ç†æ¬Šé™</h2>
            <p>æ‚¨ç›®å‰çš„è§’è‰²ç„¡æ³•è¨ªå•ç®¡ç†åŠŸèƒ½ï¼Œè«‹åˆ‡æ›åˆ°ã€Œå…¬å¸ã€è§’è‰²ã€‚</p>
          </div>
        </div>
      </div>
      <!-- éå¾€äº¤æ˜“ Tab -->
      <div id="history" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>å…¬å¸äº¤æ˜“ç´€éŒ„</h2>
            <div id="history-records-company" style="min-height: 500px;">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card history-card">
            <h2>æˆ‘çš„äº¤æ˜“ç´€éŒ„</h2>
            <div id="history-records-buyer" style="min-height: 500px;">
              <p>è¼‰å…¥ä¸­...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="card-modal" class="modal">
      <div class="modal-content">
        <button id="card-modal-close" class="modal-close">&times;</button>
        <h2>å¡ç‰‡äº¤æ˜“è©³æƒ…</h2>
        <div id="card-modal-content">
          <p>è¼‰å…¥ä¸­...
          <div class="loader"></div>
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initEthers, signer } from './js/ethers-init.js';

      // åˆç´„ ABI (æ ¹æ“šå¯¦éš›åˆç´„èª¿æ•´)
      const contractABI = [
        "function owner() external view returns (address)",
        "event CardPurchased(address indexed buyer, uint256 amount, string uid)",
        "event CardRequested(address indexed buyer, string uid)",
        "event CardApproved(string uid, address indexed buyer, uint256 tokenId)",
        "event CardRequestRejected(string uid, address buyer)",

        // CardManager ç›¸é—œå‡½å¼
        "function cardManager() view returns (address)",
        "function getCompanyCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function getAvailableCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function getPendingCardRequests() external view returns (tuple(string uid, address buyer, uint256 amount, uint256 timestamp)[])",
        "function getUserCards(address user) external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function purchaseSpecificCard(string uid, address recipient) external payable returns (string)",
        "function bindCardUID(string uid, address recipient) external",
        "function getCardPrice() external view returns (uint256)",
        "function requestCard(string uid, address recipient) external",
        "function approveTransfer(string uid) external",
        "function rejectTransfer(string uid) external",
        "function setCardPrice(uint256 newPrice, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, uint256 amount) external returns (string)",
        "function listCardForResale(string uid, uint256 price) external",
        "function getNFTHolder(string memory uid) external view returns (address)",
        "function getResaleCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function cancelResale(string uid) external",

        // TradeManager ç›¸é—œå‡½å¼
        "function tradeManager() view returns (address)",
        "function createTrade(string uid, uint256 price) external",
        "function buyerSign(uint256 tradeId) external payable",
        "function sellerSign(uint256 tradeId) external",
        "function finalize(uint256 tradeId) external",
        "function getUserTrades(address user) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function getTradeAnalytics() external view returns (uint256 totalTrades, uint256 completedTrades, uint256 pendingTrades, uint256 totalVolume)",
        "function getAvailableTrades() external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function getTrade(uint256 tradeId) external view returns (uint256 tokenId, address seller, address buyer, uint256 price, uint8 status, uint256 deadline)",
        "function uidToTradeIds(string) view returns (uint256[])",
        "function getTradesByUID(string memory uid) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function tradeCounter() view returns (uint256)",
        "function recordPrimaryTrade(string memory uid, uint256 tokenId, address buyer, uint256 price) external",
        "function recordSecondaryTrade(string memory uid, uint256 tokenId, address seller, address buyer, uint256 price) external",
        "function setUidToTokenId(string memory uid, uint256 tokenId) external",
        "function uidToTokenId(string) view returns (uint256)",
        "function purchaseResaleCard(string uid,address recipient) external payable"
      ];

      // ç‹€æ…‹è®Šæ•¸
      let contract;
      let userAccount;
      let isOwner = false;
      let contractAddress;
      let cardManagerAddress;
      let tradeManagerAddress;

      // DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
      window.addEventListener('DOMContentLoaded', () => {
        fetch('./contract-addresses.json')
          .then(res => {
            console.log("âœ… æˆåŠŸ fetch contract-addresses.json");
            return res.json();
          })
          .then(async (addresses) => {
            console.log("âœ… JSON å…§å®¹ç‚º", addresses);
            contractAddress = addresses.IdolCardSystem;
            cardManagerAddress = addresses.CardManager;
            tradeManagerAddress = addresses.TradeManager;
          })
          .catch(err => {
            console.error("éŒ¯èª¤äº†!", err);
          });

        // åˆå§‹åŒ–æ¨™ç±¤é åˆ‡æ›
        initTabs();

        // ç²å–é€£æ¥éŒ¢åŒ…æŒ‰éˆ•
        const connectBtn = document.getElementById('connectWalletBtn');
        if (!connectBtn) return;

        // åˆå§‹é»æ“Šç¶å®š
        connectBtn.addEventListener('click', connectWallet);

        // ç¶å®šå…¶ä»–æŒ‰éˆ•äº‹ä»¶ï¼Œä½†æš«æ™‚ç¦ç”¨
        const buttons = document.querySelectorAll('button:not(#connectWalletBtn):not(.role-btn)');
        buttons.forEach(btn => {
          btn.disabled = true;
        });

        // å„è§’è‰²åŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
        // å…¬å¸è§’è‰²
        document.getElementById('set-price-btn').addEventListener('click', setCardPrice);

        // ç¬¬ä¸€æ‰‹è²·å®¶è§’è‰²
        document.getElementById('request-card-btn').addEventListener('click', bindCard);

        // ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶è§’è‰²
        document.getElementById('resale-btn').addEventListener('click', resaleCard);
      });

      document.getElementById('walletBalanceBtn').addEventListener('click', async () => {
        if (!userAccount) {
          alert('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
          return;
        }
        try {
          const balanceWei = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [userAccount, 'latest']
          });
          const balanceEth = ethers.utils.formatEther(balanceWei);
          alert(`ç›®å‰çš„é¤˜é¡æ˜¯ ${balanceEth} ETH`);
        } catch (error) {
          console.error("æŸ¥è©¢é¤˜é¡å¤±æ•—:", error);
          alert('æŸ¥è©¢é¤˜é¡å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
      });

      // ç•¶å‰é¸æ“‡çš„è§’è‰²
      let currentRole = 'company';

      // åˆ‡æ›è§’è‰²
      function switchRole(role) {
        currentRole = role;

        let roleDescription = '';

        switch (role) {
          case 'company':
            roleDescription = 'ç•¶å‰è§’è‰²: å…¬å¸ - è² è²¬ç™¼è¡Œå¡ç‰‡å’Œå¯©æ‰¹å¡ç‰‡ç¶å®šè«‹æ±‚';
            document.querySelector('.tab[data-tab="purchase"]').textContent = 'ç™¼è¡Œå¡ç‰‡';
            break;
          case 'buyer':
            roleDescription = 'ç•¶å‰è§’è‰²: æ™®é€šç”¨æˆ¶ - å¯ä»¥è³¼è²·å¡ç‰‡ã€è«‹æ±‚ç¶å®šèˆ‡å¸‚å ´äº¤æ˜“';
            document.querySelector('.tab[data-tab="purchase"]').textContent = 'è³¼è²·å¡ç‰‡';
            break;
        }

        // æ›´æ–°å…§å®¹é¡¯ç¤º
        document.querySelectorAll('.role-content').forEach(content => {
          content.style.display = 'none';
        });

        if (role === 'company') {
          document.querySelectorAll('.company-role').forEach(content => {
            content.style.display = 'block';
          });
        } else {
          document.querySelectorAll('.buyer-role').forEach(content => {
            content.style.display = 'block';
          });
        }

        // å¦‚æœéŒ¢åŒ…å·²é€£æ¥ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰è§’è‰²çš„æ•¸æ“š
        if (contract && userAccount) {
          loadRoleSpecificData(role);
        }
      }

      async function awaitContractsReady() {
        while (!contractAddress || !cardManagerAddress || !tradeManagerAddress) {
          console.log("â³ ç­‰å¾…åˆç´„åœ°å€è¼‰å…¥...");
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        console.log("âœ… åˆç´„åœ°å€å·²æº–å‚™å¥½");
      }

      // é€£æ¥éŒ¢åŒ…
      async function connectWallet() {
        await awaitContractsReady();

        const connectBtn = document.getElementById('connectWalletBtn');
        const connectionStatus = document.getElementById('connection-status');

        try {
          connectionStatus.innerHTML = '<span>é€£æ¥ä¸­... <div class="loader"></div></span>';
          connectionStatus.className = 'status info';

          const result = await initEthers(contractABI, contractAddress);
          contract = result.contract;
          userAccount = result.userAddress;
          console.log("ä½¿ç”¨è€…å¸³æˆ¶:", userAccount);
          console.log("åˆç´„æ˜¯å¦é€£æ¥æˆåŠŸï¼Ÿ", contract);

          connectBtn.textContent = `å·²é€£æ¥: ${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
          connectionStatus.textContent = `å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š${userAccount}`;
          connectionStatus.className = 'status success';

          // æª¢æŸ¥æ˜¯å¦ç‚ºåˆç´„æ“æœ‰è€…
          const owner = await contract.owner();
          isOwner = (owner.toLowerCase() === userAccount.toLowerCase());
          console.log("ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºæ“æœ‰è€…ï¼Ÿ", isOwner);
          console.log("ä½¿ç”¨çš„åˆç´„åœ°å€:", contractAddress);

          // é¡¯ç¤ºæˆ–éš±è—ç®¡ç†å“¡é ç±¤
          const adminTab = document.querySelector('.tab[data-tab="admin"]');
          if (isOwner) {
            if (adminTab) adminTab.style.display = 'block';
            currentRole = 'company';
          } else {
            if (adminTab) adminTab.style.display = 'none';
            currentRole = 'buyer';
          }

          // æ§åˆ¶é¡¯ç¤ºå…¬å¸è§’è‰²æˆ–è²·å®¶è§’è‰²å…§å®¹
          if (isOwner) {
            document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.company-role').forEach(el => el.style.display = 'block');
          } else {
            document.querySelectorAll('.company-role').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'block');
            await loadResaleCardsMarket();
          }

          // é¡¯ç¤ºæ¨™ç±¤èˆ‡å®¹å™¨
          const tabsContainer = document.querySelector('.tabs');
          const mainContainer = document.querySelector('.content-grid');
          if (tabsContainer) {
            tabsContainer.style.display = 'flex';
            tabsContainer.classList.add('show');
          }
          if (mainContainer) {
            mainContainer.style.display = 'grid';
            mainContainer.classList.add('show');
          }

          // å•Ÿç”¨é™¤é€£æ¥æŒ‰éˆ•å¤–æ‰€æœ‰æŒ‰éˆ•
          document.querySelectorAll('button:not(#connectWalletBtn)').forEach(btn => btn.disabled = false);

          // åªåœ¨ç¢ºå®šèº«ä»½å¾Œï¼Œæ‰è¼‰å…¥è³‡æ–™
          await loadRoleSpecificData(currentRole);

          // ç›£è½å¸³æˆ¶è®Šå‹•äº‹ä»¶ï¼Œåˆ·æ–°é é¢
          if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
              window.location.reload();
            });
          }

          // è¨­å®šåˆç´„äº‹ä»¶ç›£è½å™¨
          setupEventListeners();

        } catch (error) {
          console.error("é€£æ¥ MetaMask å¤±æ•—:", error);
          connectionStatus.textContent = 'é€£æ¥éŒ¢åŒ…å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
          connectionStatus.className = 'status error';
        }
      }

      // æ ¹æ“šè§’è‰²è¼‰å…¥ç‰¹å®šæ•¸æ“š
      async function loadRoleSpecificData(role) {
        try {
          // ç²å–å¡ç‰‡åƒ¹æ ¼ï¼ˆå„è§’è‰²éƒ½éœ€è¦ï¼‰
          const priceWei = await contract.getCardPrice();
          const priceEth = ethers.utils.formatEther(priceWei);

          // æ›´æ–°å„è§’è‰²é¡¯ç¤ºçš„åƒ¹æ ¼
          const priceElement = document.getElementById('card-price');
          if (priceElement) {
            priceElement.textContent = `å¡ç‰‡åƒ¹æ ¼: ${priceEth} ETH`;
          }

          // æ ¹æ“šè§’è‰²è¼‰å…¥ä¸åŒæ•¸æ“š
          switch (role) {
            case 'company':
              if (isOwner) {
                loadPendingRequests();
                loadCardStats();
                loadAllTradesOverview();
                loadTradeAnalytics();
                loadHistoryRecords();
                document.querySelector('.tab[data-tab="purchase"]').textContent = 'ç™¼è¡Œå¡ç‰‡';
              }
              break;

            case 'buyer':
              loadMyCardsSecond();
              loadAvailableTradesSecond();
              loadMyTradesSecond();
              loadAvailableCardsMarket();
              loadMyCardsFirst();
              loadAvailableTradesFirst();
              loadMySalesFirst();
              loadHistoryRecords();
              document.querySelector('.tab[data-tab="purchase"]').textContent = 'è³¼è²·å¡ç‰‡';
              break;
          }
        } catch (error) {
          console.error(`è¼‰å…¥${role}è§’è‰²æ•¸æ“šå¤±æ•—:`, error);
        }
      }

      // è¼‰å…¥å¯è³¼è²·å¡ç‰‡å¸‚å ´ - ä¿®æ”¹ç‚ºç¾ä»£å¡ç‰‡æ¨£å¼
      async function loadAvailableCardsMarket() {
        const marketDiv = document.getElementById('available-cards-market');

        try {
          marketDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const availableCards = await contract.getAvailableCards();
          console.log("å¯ç”¨å¡ç‰‡:", availableCards);

          if (availableCards && availableCards.length > 0) {
            let cardsHTML = '';

            for (const card of availableCards) {
              if (card.isSold) continue;

              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              const priceWei = card.listPrice.toString();

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ç„¡åœ–ç‰‡</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>å¡ç‰‡ç·¨è™Ÿ: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="purchaseSpecificCard('${card.uid}', '${priceWei}')" class="btn-success">è³¼è²·</button>
                    <button onclick="viewCardDetails('${card.uid}')">æŸ¥çœ‹è©³æƒ…</button>
                  </div>
                </div>
              </div>
            `;
            }

            marketDiv.innerHTML = cardsHTML;
          } else {
            marketDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯è³¼è²·çš„å¡ç‰‡ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥å¸‚å ´å¡ç‰‡å¤±æ•—:", error);
          marketDiv.innerHTML = `<p class="error">è¼‰å…¥å¸‚å ´å¡ç‰‡å¤±æ•—: ${error.message}</p>`;
        }
      }

      // è¼‰å…¥è½‰å”®å¡ç‰‡å¸‚å ´ - ä¿®æ”¹ç‚ºç¾ä»£å¡ç‰‡æ¨£å¼
      async function loadResaleCardsMarket() {
        const resaleDiv = document.getElementById('resale-cards-market');

        try {
          resaleDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const userCards = await contract.getUserCards(userAccount);
          const ownedUIDs = new Set(userCards.map(card => card.uid));

          const resaleCards = await contract.getResaleCards();
          console.log("äºŒæ‰‹å¡ç‰‡:", resaleCards);

          const filteredResaleCards = resaleCards.filter(card => {
            const cardUid = card[0];
            return !ownedUIDs.has(cardUid);
          });

          if (filteredResaleCards.length > 0) {
            let cardsHTML = '';

            for (const card of filteredResaleCards) {
              const uid = card[0];
              const idolGroup = card[1];
              const member = card[2];
              const cardNumber = card[3];
              const listPrice = card[4];
              const photoURI = card[5];
              const isSold = card[6];

              const priceEth = ethers.utils.formatEther(listPrice.toString());
              const shortUID = `${uid.slice(0, 10)}...${uid.slice(-6)}`;

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${photoURI ?
                  `<img src="${photoURI}" alt="${idolGroup} - ${member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ç„¡åœ–ç‰‡</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${idolGroup} - ${member}</div>
                  <div class="idol-card-info">
                    <div>å¡ç‰‡ç·¨è™Ÿ: ${cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--secondary-color); font-weight: 600;">ğŸ’ è½‰å”®å¡ç‰‡</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="buyResaleCard('${uid}', '${listPrice}')" class="btn-secondary">è³¼è²·</button>
                    <button onclick="viewCardDetails('${uid}')">æŸ¥çœ‹è©³æƒ…</button>
                  </div>
                  <div class="transaction-history">
                    <div class="transaction-item">
                      <span class="transaction-action">ğŸ”„ è½‰å”®ä¸­</span>
                      <span class="transaction-amount">${priceEth} ETH</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            }

            resaleDiv.innerHTML = cardsHTML;
          } else {
            resaleDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰è½‰å”®çš„å¡ç‰‡ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥äºŒæ‰‹å¸‚å ´å¡ç‰‡å¤±æ•—:", error);
          resaleDiv.innerHTML = `<p class="error">è¼‰å…¥äºŒæ‰‹å¸‚å ´å¡ç‰‡å¤±æ•—: ${error.message}</p>`;
        }
      }

      async function loadHistoryRecords() {
        try {
          // åˆå§‹åŒ– cardManagerContract
          if (!cardManagerContract) {
            const cardManagerAbi = [
              "event CardPurchased(address indexed buyer, uint256 amount, string uid)",
              "event CardApproved(string uid, address indexed buyer, uint256 tokenId)",
              "event CardRequestRejected(string uid, address buyer)"
            ];
            const provider = contract.provider;
            const signer = provider.getSigner(userAccount);
            cardManagerContract = new ethers.Contract(cardManagerAddress, cardManagerAbi, signer);
          }

          let historyDiv;
          if (currentRole === 'company') {
            historyDiv = document.getElementById('history-records-company');
          } else {
            historyDiv = document.getElementById('history-records-buyer');
          }

          if (!historyDiv) {
            console.error('âŒ æ‰¾ä¸åˆ° historyDiv å…ƒç´ ï¼');
            return;
          }

          console.log("ğŸ” historyDiv å–å¾—æˆåŠŸ:", historyDiv);
          historyDiv.style.display = 'block';
          historyDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const fromBlock = 0; // æ‹‰å…¨æ­·å²

          let records = [];

          if (currentRole === 'company') {
            // å…¬å¸çœ‹æ‰€æœ‰äº‹ä»¶
            const [purchaseEvents, approveEvents] = await Promise.all([
              cardManagerContract.queryFilter(cardManagerContract.filters.CardPurchased(), fromBlock, 'latest'),
              cardManagerContract.queryFilter(cardManagerContract.filters.CardApproved(), fromBlock, 'latest')
            ]);

            await processCompanyEventsSimple(records, purchaseEvents, approveEvents);

          } else {
            // ç”¨æˆ¶çœ‹è‡ªå·±ç›¸é—œçš„äº‹ä»¶
            const [allPurchaseEvents, myApproveEvents] = await Promise.all([
              // ç²å–æ‰€æœ‰è³¼è²·äº‹ä»¶ï¼ˆç”¨ä¾†åˆ¤æ–·ä¸€æ‰‹/äºŒæ‰‹ï¼‰
              cardManagerContract.queryFilter(cardManagerContract.filters.CardPurchased(), fromBlock, 'latest'),
              // æˆ‘çš„å¯©æ‰¹äº‹ä»¶
              cardManagerContract.queryFilter(cardManagerContract.filters.CardApproved(null, userAccount), fromBlock, 'latest')
            ]);

            await processUserEventsSimple(records, allPurchaseEvents, myApproveEvents);
          }

          // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
          records.sort((a, b) => b.timestamp - a.timestamp);

          displayHistoryRecordsSimple(historyDiv, records);

        } catch (error) {
          console.error("âŒ è¼‰å…¥éå¾€ç´€éŒ„å¤±æ•—:", error);
          let historyDiv = currentRole === 'company'
            ? document.getElementById('history-records-company')
            : document.getElementById('history-records-buyer');
          if (historyDiv) {
            historyDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--error-color);">
          <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
          <h3>è¼‰å…¥å¤±æ•—</h3>
          <p>ç„¡æ³•è¼‰å…¥äº¤æ˜“ç´€éŒ„ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>
          <details style="margin-top: 1rem; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
            <summary>éŒ¯èª¤è©³æƒ…</summary>
            <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.8em;">${error.message}</pre>
          </details>
        </div>
      `;
          }
        }
      }

      // è™•ç†å…¬å¸äº‹ä»¶ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      async function processCompanyEventsSimple(records, purchaseEvents, approveEvents) {
        // å»ºç«‹ UID åˆ°è³¼è²·æ­·å²çš„æ˜ å°„ï¼ˆå…¬å¸è¦–è§’ï¼‰
        const uidPurchaseHistory = {};

        // å…ˆè™•ç†æ‰€æœ‰è³¼è²·äº‹ä»¶ï¼Œå»ºç«‹æ¯å€‹ UID çš„è³¼è²·æ­·å²
        for (const event of purchaseEvents) {
          const uid = event.args[2];
          const buyer = event.args[0];
          const blockNumber = event.blockNumber;

          if (!uidPurchaseHistory[uid]) {
            uidPurchaseHistory[uid] = [];
          }

          uidPurchaseHistory[uid].push({
            buyer: buyer,
            blockNumber: blockNumber,
            event: event
          });
        }

        // ç‚ºæ¯å€‹ UID æŒ‰å€å¡Šè™Ÿæ’åº
        for (const uid in uidPurchaseHistory) {
          uidPurchaseHistory[uid].sort((a, b) => a.blockNumber - b.blockNumber);
        }

        // è™•ç†è³¼è²·äº‹ä»¶
        for (const event of purchaseEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[2];
            const buyer = event.args[0];
            const amount = event.args[1];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;
            const amountEth = ethers.utils.formatEther(amount);

            // æª¢æŸ¥é€™æ˜¯å¦æ˜¯é€™å€‹ UID çš„ç¬¬ä¸€æ¬¡è³¼è²·
            const purchaseHistory = uidPurchaseHistory[uid] || [];
            const isFirstPurchase = purchaseHistory.length > 0 &&
              purchaseHistory[0].blockNumber === event.blockNumber;

            let sellerInfo = '';
            if (!isFirstPurchase) {
              // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è³¼è²·ï¼Œæ‰¾å‡ºè³£å®¶
              const currentPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);
              if (currentPurchaseIndex > 0) {
                const previousOwner = purchaseHistory[currentPurchaseIndex - 1].buyer;
                const shortSeller = `${previousOwner.slice(0, 6)}...${previousOwner.slice(-4)}`;
                sellerInfo = `, è³£å®¶: ${shortSeller}`;
              }
            }

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: isFirstPurchase ? 'company-primary-sale' : 'company-secondary-sale',
              event: isFirstPurchase ? `ğŸ’° ä¸€æ‰‹éŠ·å”®` : `ğŸ”„ äºŒæ‰‹äº¤æ˜“`,
              details: `UID: ${shortUID}, è²·å®¶: ${shortBuyer}, é‡‘é¡: ${amountEth} ETH${sellerInfo}`,
              fullUID: uid,
              fullBuyer: buyer
            });
          } catch (error) {
            console.warn("è™•ç†è³¼è²·äº‹ä»¶å¤±æ•—:", error);
          }
        }

        // è™•ç†å¯©æ‰¹äº‹ä»¶
        for (const event of approveEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[0];
            const buyer = event.args[1];
            const tokenId = event.args[2];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: 'approve',
              event: `âœ… å¯©æ‰¹é€šé`,
              details: `UID: ${shortUID}, è²·å®¶: ${shortBuyer}, Token ID: ${tokenId}`,
              fullUID: uid,
              fullBuyer: buyer
            });
          } catch (error) {
            console.warn("è™•ç†å¯©æ‰¹äº‹ä»¶å¤±æ•—:", error);
          }
        }
      }

      // è™•ç†ç”¨æˆ¶äº‹ä»¶ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      async function processUserEventsSimple(records, allPurchaseEvents, approveEvents) {
        // å»ºç«‹ UID åˆ°è³¼è²·æ­·å²çš„æ˜ å°„
        const uidPurchaseHistory = {};

        // å…ˆè™•ç†æ‰€æœ‰è³¼è²·äº‹ä»¶ï¼Œå»ºç«‹æ¯å€‹ UID çš„è³¼è²·æ­·å²
        for (const event of allPurchaseEvents) {
          const uid = event.args[2];
          const buyer = event.args[0];
          const blockNumber = event.blockNumber;

          if (!uidPurchaseHistory[uid]) {
            uidPurchaseHistory[uid] = [];
          }

          uidPurchaseHistory[uid].push({
            buyer: buyer,
            blockNumber: blockNumber,
            event: event
          });
        }

        // ç‚ºæ¯å€‹ UID æŒ‰å€å¡Šè™Ÿæ’åº
        for (const uid in uidPurchaseHistory) {
          uidPurchaseHistory[uid].sort((a, b) => a.blockNumber - b.blockNumber);
        }

        // è™•ç†èˆ‡ç•¶å‰ç”¨æˆ¶ç›¸é—œçš„è³¼è²·äº‹ä»¶
        for (const event of allPurchaseEvents) {
          const buyer = event.args[0];
          if (buyer.toLowerCase() !== userAccount.toLowerCase()) {
            continue; // è·³éä¸æ˜¯ç•¶å‰ç”¨æˆ¶çš„è³¼è²·
          }

          try {
            const block = await event.getBlock();
            const uid = event.args[2];
            const amount = event.args[1];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const amountEth = ethers.utils.formatEther(amount);

            // æª¢æŸ¥é€™æ˜¯å¦æ˜¯é€™å€‹ UID çš„ç¬¬ä¸€æ¬¡è³¼è²·
            const purchaseHistory = uidPurchaseHistory[uid] || [];
            const isFirstPurchase = purchaseHistory.length > 0 &&
              purchaseHistory[0].blockNumber === event.blockNumber;

            let eventType, eventText, details;

            if (isFirstPurchase) {
              // ç¬¬ä¸€æ¬¡è³¼è²· = ä¸€æ‰‹äº¤æ˜“
              eventType = 'my-primary-purchase';
              eventText = `ğŸ’° ä¸€æ‰‹è³¼è²·`;
              details = `UID: ${shortUID}, é‡‘é¡: ${amountEth} ETH`;
            } else {
              // å¾ŒçºŒè³¼è²· = äºŒæ‰‹äº¤æ˜“
              // æ‰¾å‡ºè³£å®¶ï¼ˆå‰ä¸€å€‹æ“æœ‰è€…ï¼‰
              const myPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);
              let sellerInfo = '';

              if (myPurchaseIndex > 0) {
                const previousOwner = purchaseHistory[myPurchaseIndex - 1].buyer;
                const shortSeller = `${previousOwner.slice(0, 6)}...${previousOwner.slice(-4)}`;
                sellerInfo = `, è³£å®¶: ${shortSeller}`;
              }

              eventType = 'my-secondary-purchase';
              eventText = `ğŸ›’ äºŒæ‰‹è³¼è²·`;
              details = `UID: ${shortUID}, é‡‘é¡: ${amountEth} ETH${sellerInfo}`;
            }

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: eventType,
              event: eventText,
              details: details,
              fullUID: uid
            });
          } catch (error) {
            console.warn("è™•ç†æˆ‘çš„è³¼è²·äº‹ä»¶å¤±æ•—:", error);
          }
        }

        // è™•ç†æˆ‘ä½œç‚ºè³£å®¶çš„äº¤æ˜“ï¼ˆæŸ¥æ‰¾èª°å¾æˆ‘é€™è£¡è²·äº†å¡ç‰‡ï¼‰
        for (const event of allPurchaseEvents) {
          const buyer = event.args[0];
          if (buyer.toLowerCase() === userAccount.toLowerCase()) {
            continue; // è·³éæˆ‘è‡ªå·±çš„è³¼è²·
          }

          try {
            const uid = event.args[2];
            const purchaseHistory = uidPurchaseHistory[uid] || [];

            // æ‰¾å‡ºé€™æ¬¡è³¼è²·å‰çš„ä¸Šä¸€å€‹è³¼è²·è€…æ˜¯å¦æ˜¯æˆ‘
            const buyerPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);

            if (buyerPurchaseIndex > 0) {
              const previousOwner = purchaseHistory[buyerPurchaseIndex - 1].buyer;

              if (previousOwner.toLowerCase() === userAccount.toLowerCase()) {
                // æˆ‘æ˜¯è³£å®¶ï¼
                const block = await event.getBlock();
                const amount = event.args[1];
                const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
                const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;
                const amountEth = ethers.utils.formatEther(amount);

                records.push({
                  blockNumber: event.blockNumber,
                  timestamp: block.timestamp,
                  type: 'my-sale',
                  event: `ğŸ’¸ å¡ç‰‡è²©å”®`,
                  details: `UID: ${shortUID}, è²·å®¶: ${shortBuyer}, é‡‘é¡: ${amountEth} ETH`,
                  fullUID: uid,
                  fullBuyer: buyer
                });
              }
            }
          } catch (error) {
            console.warn("è™•ç†æˆ‘çš„è²©å”®äº‹ä»¶å¤±æ•—:", error);
          }
        }

        // è™•ç†å¯©æ‰¹äº‹ä»¶
        for (const event of approveEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[0];
            const tokenId = event.args[2];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: 'my-approve',
              event: `âœ… å¯©æ‰¹é€šé`,
              details: `UID: ${shortUID}, Token ID: ${tokenId}`,
              fullUID: uid
            });
          } catch (error) {
            console.warn("è™•ç†æˆ‘çš„å¯©æ‰¹äº‹ä»¶å¤±æ•—:", error);
          }
        }
      }

      // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–æ¬¡è³¼è²·
      async function isFirstTimePurchase(uid, currentBlockNumber) {
        try {
          const purchaseFilter = cardManagerContract.filters.CardPurchased(null, null, uid);
          const purchaseEvents = await cardManagerContract.queryFilter(purchaseFilter, 0, 'latest');

          // æ‰¾å‡ºæœ€æ—©çš„è³¼è²·äº‹ä»¶
          if (purchaseEvents.length === 0) return true;

          const earliestPurchase = purchaseEvents.reduce((earliest, current) => {
            return current.blockNumber < earliest.blockNumber ? current : earliest;
          });

          return earliestPurchase.blockNumber === currentBlockNumber;
        } catch (error) {
          console.warn("æª¢æŸ¥é¦–æ¬¡è³¼è²·å¤±æ•—:", error);
          return true; // é è¨­ç‚ºé¦–æ¬¡è³¼è²·
        }
      }

      // é¡¯ç¤ºæ­·å²è¨˜éŒ„ï¼ˆç°¡åŒ–ç‰ˆï¼‰
      function displayHistoryRecordsSimple(historyDiv, records) {
        if (records.length > 0) {
          console.log("ğŸ“š records length", records.length);

          let html = '<div style="overflow-x: auto;"><table class="modern-table">';
          html += '<thead><tr><th>æ™‚é–“</th><th>å€å¡Šè™Ÿ</th><th>äº‹ä»¶é¡å‹</th><th>è©³ç´°è³‡è¨Š</th></tr></thead><tbody>';

          for (const record of records) {
            const date = new Date(record.timestamp * 1000).toLocaleString('zh-TW');
            let typeClass = '';

            switch (record.type) {
              case 'company-primary-sale':
              case 'my-primary-purchase':
                typeClass = 'status-completed';
                break;
              case 'approve':
              case 'my-approve':
                typeClass = 'status-buyer-signed';
                break;
              case 'my-sale':
                typeClass = 'status-seller-signed';
                break;
              case 'my-secondary-purchase':
              case 'company-secondary-sale':
                typeClass = 'status-created';
                break;
              default:
                typeClass = 'status-created';
            }

            html += `
        <tr>
          <td style="min-width: 140px;">${date}</td>
          <td style="font-family: monospace;">#${record.blockNumber}</td>
          <td><span class="trade-status ${typeClass}">${record.event}</span></td>
          <td style="font-size: 0.9em;" title="${record.details}">${record.details}</td>
        </tr>
      `;
          }

          html += '</tbody></table></div>';

          // çµ±è¨ˆè³‡è¨Š
          const primaryPurchaseCount = records.filter(r => r.type === 'company-primary-sale' || r.type === 'my-primary-purchase').length;
          const secondaryPurchaseCount = records.filter(r => r.type === 'my-secondary-purchase' || r.type === 'company-secondary-sale').length;
          const saleCount = records.filter(r => r.type === 'my-sale').length;
          const approveCount = records.filter(r => r.type === 'approve' || r.type === 'my-approve').length;

          html += `
      <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(236, 72, 153, 0.05); border-radius: 12px; border-left: 4px solid var(--primary-color);">
        <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">çµ±è¨ˆæ‘˜è¦</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; font-size: 0.9rem;">
          <div>ğŸ’° ä¸€æ‰‹äº¤æ˜“: <strong>${primaryPurchaseCount}</strong></div>
          <div>ğŸ›’ äºŒæ‰‹äº¤æ˜“: <strong>${secondaryPurchaseCount}</strong></div>
          <div>ğŸ’¸ è²©å”®æ¬¡æ•¸: <strong>${saleCount}</strong></div>
          <div>âœ… å¯©æ‰¹é€šé: <strong>${approveCount}</strong></div>
          <div>ğŸ“Œ ç¸½è¨ˆç´€éŒ„: <strong>${records.length}</strong></div>
        </div>
      </div>
    `;

          historyDiv.innerHTML = html;
          console.log('âœ… å·²æˆåŠŸè¼‰å…¥äº¤æ˜“ç´€éŒ„');
        } else {
          historyDiv.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“­</div>
        <h3>ç›®å‰æ²’æœ‰äº¤æ˜“ç´€éŒ„</h3>
        <p>ç•¶æ‚¨é–‹å§‹ä½¿ç”¨ç³»çµ±å¾Œï¼Œäº¤æ˜“è¨˜éŒ„æœƒå‡ºç¾åœ¨é€™è£¡ã€‚</p>
      </div>
    `;
          console.log('âš ï¸ æ²’æœ‰ä»»ä½•æ­·å²ç´€éŒ„');
        }
      }
      // è¼‰å…¥æˆ‘çš„å¡ç‰‡ - ä¿®æ”¹ç‚ºç¾ä»£å¡ç‰‡æ¨£å¼
      async function loadMyCardsFirst() {
        try {
          const myCardsDiv = document.getElementById('my-cards-list-first');
          myCardsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const userCards = await contract.getUserCards(userAccount);
          const resaleCards = await contract.getResaleCards();
          const resaleUIDs = new Set(resaleCards.map(card => card[0]));

          const unsoldUserCards = userCards.filter(card => !resaleUIDs.has(card.uid));

          if (unsoldUserCards.length > 0) {
            let cardsHTML = '';

            for (const card of unsoldUserCards) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ç„¡åœ–ç‰‡</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>å¡ç‰‡ç·¨è™Ÿ: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--success-color); font-weight: 600;">âœ… å·²æ“æœ‰</div>
                  </div>
                  <div class="idol-card-price">åŸåƒ¹ ${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="viewCardDetails('${card.uid}')">æŸ¥çœ‹è©³æƒ…</button>
                  </div>
                </div>
              </div>
            `;
            }

            myCardsDiv.innerHTML = cardsHTML;
          } else {
            myCardsDiv.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰ä»»ä½•æœªä¸Šæ¶çš„å¡ç‰‡ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¡ç‰‡å¤±æ•—:", error);
          document.getElementById('my-cards-list-first').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥æˆ‘çš„ä¸Šæ¶å¡ç‰‡ - ä¿®æ”¹ç‚ºç¾ä»£å¡ç‰‡æ¨£å¼
      async function loadMyCardsSecond() {
        try {
          const myCardsDiv = document.getElementById('my-cards-list-second');
          const cardToSell = document.getElementById('card-to-sell');

          myCardsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          // 1. è¼‰å…¥è‡ªå·±æ“æœ‰çš„ NFT
          const userCards = await contract.getUserCards(userAccount);
          // 2. è¼‰å…¥å·²ä¸Šæ¶çš„ UID
          const resaleCards = await contract.getResaleCards();
          const resaleUIDs = new Set(resaleCards.map(c => c.uid));

          // é¡¯ç¤ºå·²ä¸Šæ¶çš„å¡ç‰‡
          const listed = userCards.filter(c => resaleUIDs.has(c.uid));
          let cardsHTML='';
          if (listed.length) {
            for (const card of listed) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              
              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ç„¡åœ–ç‰‡</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>å¡ç‰‡ç·¨è™Ÿ: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--warning-color); font-weight: 600;">ä¸Šæ¶ä¸­</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="cancelResaleCard('${card.uid}')">å–æ¶ˆä¸Šæ¶</button>
                  </div>
                </div>
              </div>
            `;
            }

            myCardsDiv.innerHTML = cardsHTML;
          } else {
            myCardsDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰æ‚¨ä¸Šæ¶ä¸­çš„å¡ç‰‡ã€‚</p>';
          }

          // å°‡æœªä¸Šæ¶å¡ç‰‡åŠ åˆ°ä¸‹æ‹‰é¸å–®
          // æ¸…ç©ºä¸‹æ‹‰é¸å–®
          while (cardToSell.options.length > 1) cardToSell.remove(1);
          const unlisted = userCards.filter(c => !resaleUIDs.has(c.uid));
          for (const c of unlisted) {
            const opt = document.createElement('option');
            opt.value = c.uid;
            opt.textContent = `${c.idolGroup} - ${c.member} (#${c.cardNumber})`;
            cardToSell.appendChild(opt);
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è³£å®¶å¡ç‰‡å¤±æ•—:", error);
          document.getElementById('my-cards-list-second').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥å¡ç‰‡çµ±è¨ˆ - ä½¿ç”¨ç¾ä»£è¡¨æ ¼æ¨£å¼
      async function loadCardStats() {
        try {
          const statsDiv = document.getElementById('card-stats');
          statsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const cards = await contract.getCompanyCards();

          if (cards && cards.length > 0) {
            let html = '<table class="modern-table">';
            html += '<thead><tr><th>UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>å¡è™Ÿ</th><th>åƒ¹æ ¼ (ETH)</th><th>ç‹€æ…‹</th></tr></thead><tbody>';

            for (const card of cards) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              const soldText = card.isSold ?
                '<span class="trade-status status-completed">âœ”ï¸ å·²å”®å‡º</span>' :
                '<span class="trade-status status-created">âŒ å°šæœªå”®å‡º</span>';

              html += `
              <tr>
                <td title="${card.uid}">${shortUID}</td>
                <td>${card.idolGroup}</td>
                <td>${card.member}</td>
                <td>${card.cardNumber}</td>
                <td>${priceEth}</td>
                <td>${soldText}</td>
              </tr>
            `;
            }

            html += '</tbody></table>';
            statsDiv.innerHTML = html;
          } else {
            statsDiv.innerHTML = '<p>ç›®å‰å°šæœªç™¼è¡Œä»»ä½•å¡ç‰‡ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥å…¬å¸å¡ç‰‡çµ±è¨ˆå¤±æ•—:", error);
          document.getElementById('card-stats').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡è³‡è¨Šå¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥å¾…å¯©æ‰¹è«‹æ±‚ - ä½¿ç”¨ç¾ä»£è¡¨æ ¼æ¨£å¼
      async function loadPendingRequests() {
        if (!isOwner) {
          document.getElementById('pending-requests').innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯æŸ¥çœ‹å¾…è™•ç†è«‹æ±‚ã€‚</p>';
          return;
        }

        try {
          const pendingDiv = document.getElementById('pending-requests');
          pendingDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const pendingRequests = await contract.getPendingCardRequests();

          if (pendingRequests && pendingRequests.length > 0) {
            let requestsHTML = '<table class="modern-table">';
            requestsHTML += '<thead><tr><th>å¡ç‰‡UID</th><th>è²·å®¶åœ°å€</th><th>é‡‘é¡</th><th>è«‹æ±‚æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody>';

            for (const request of pendingRequests) {
              const shortUID = `${request.uid.slice(0, 10)}...${request.uid.slice(-6)}`;
              const date = new Date(request.timestamp * 1000);
              const formattedDate = date.toLocaleString();
              const amount = ethers.utils.formatEther(request.amount);

              requestsHTML += `
              <tr>
                <td title="${request.uid}">${shortUID}</td>
                <td>${request.buyer}</td>
                <td>${amount} ETH</td>
                <td>${formattedDate}</td>
                <td>
                  <button onclick="approveTransfer('${request.uid}')" class="btn-success" style="margin-right: 0.5rem;">æ‰¹å‡†</button>
                  <button onclick="rejectTransfer('${request.uid}')" class="btn-danger">æ‹’çµ•</button>
                </td>
              </tr>
            `;
            }

            requestsHTML += '</tbody></table>';
            pendingDiv.innerHTML = requestsHTML;
          } else {
            pendingDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¾…è™•ç†çš„è«‹æ±‚ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥å¾…è™•ç†è«‹æ±‚å¤±æ•—:", error);
          document.getElementById('pending-requests').innerHTML = `<p class="error">è¼‰å…¥å¾…è™•ç†è«‹æ±‚å¤±æ•—: ${error.message}</p>`;
        }
      }

      // è¼‰å…¥å¯ç”¨äº¤æ˜“ - ä½¿ç”¨ç¾ä»£è¡¨æ ¼æ¨£å¼
      async function loadAvailableTradesFirst() {
        try {
          const tradesDiv = document.getElementById('available-trades-first');
          tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const trades = await contract.getAvailableTrades();

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr></thead><tbody>';

            for (const trade of trades) {
              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>
                  <button onclick="buyCard(${trade.tradeId}, '${trade.price}')" class="btn-success">è³¼è²·</button>
                </td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„äº¤æ˜“ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¯ç”¨äº¤æ˜“å¤±æ•—:", error);
          document.getElementById('available-trades-first').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥æˆ‘çš„éŠ·å”® - ä½¿ç”¨ç¾ä»£è¡¨æ ¼æ¨£å¼
      async function loadMySalesFirst() {
        try {
          const salesDiv = document.getElementById('my-sales-first');
          salesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const trades = await contract.getUserTrades(userAccount);

          if (trades && trades.length > 0) {
            const sales = trades.filter(trade => trade.seller.toLowerCase() === userAccount.toLowerCase());

            if (sales.length > 0) {
              let salesHTML = '<table class="modern-table">';
              salesHTML += '<thead><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è²·å®¶</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';

              for (const sale of sales) {
                let statusText = '';
                let actionButton = '';

                switch (sale.status) {
                  case 0:
                    statusText = '<span class="trade-status status-created">å·²å‰µå»º</span>';
                    break;
                  case 1:
                    statusText = '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
                    actionButton = `<button onclick="sellerSign(${sale.tradeId})" class="btn-success">ç°½ç½²äº¤æ˜“</button>`;
                    break;
                  case 2:
                    statusText = '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
                    break;
                  case 5:
                    statusText = '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
                    break;
                  default:
                    statusText = `<span class="trade-status">ç‹€æ…‹: ${sale.status}</span>`;
                }

                salesHTML += `
                <tr>
                  <td>#${sale.tradeId}</td>
                  <td>#${sale.tokenId}</td>
                  <td>${sale.buyer ? `${sale.buyer.slice(0, 6)}...${sale.buyer.slice(-4)}` : 'æœªå®š'}</td>
                  <td>${ethers.utils.formatEther(sale.price)} ETH</td>
                  <td>${statusText}</td>
                  <td>${actionButton}</td>
                </tr>
              `;
              }

              salesHTML += '</tbody></table>';
              salesDiv.innerHTML = salesHTML;
            } else {
              salesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•éŠ·å”®è¨˜éŒ„ã€‚</p>';
            }
          } else {
            salesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•éŠ·å”®è¨˜éŒ„ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶éŠ·å”®å¤±æ•—:", error);
          document.getElementById('my-sales-first').innerHTML = '<p class="error">è¼‰å…¥éŠ·å”®è¨˜éŒ„å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶å¯ç”¨äº¤æ˜“
      async function loadAvailableTradesSecond() {
        try {
          const tradesDiv = document.getElementById('available-trades-second');
          tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const trades = await contract.getAvailableTrades();

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr></thead><tbody>';

            for (const trade of trades) {
              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>
                  <button onclick="buyCard(${trade.tradeId}, '${trade.price}')" class="btn-success">è³¼è²·</button>
                </td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„äº¤æ˜“ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶å¯ç”¨äº¤æ˜“å¤±æ•—:", error);
          document.getElementById('available-trades-second').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
        }
      }
      async function fetchResaleStatus(uid) {
        const resaleCards = await contract.getResaleCards();
        // getResaleCards å›å‚³ CardDisplay[]ï¼Œuid åœ¨æ¯å€‹å…ƒç´ çš„ .uid ä¸Š
        return resaleCards.some(c => c.uid === uid);
      }

      window.cancelResaleCard = async function cancelResaleCard(uid) {
        console.log("ä½ å°‡ cancel çš„ uid=", uid);
        const resaleCards = await contract.getResaleCards();
        console.log("æ‰€æœ‰ä¸Šæ¶UID", resaleCards.map(c => c.uid));
        if (!confirm(`ç¢ºå®šè¦å–æ¶ˆä¸Šæ¶å¡ç‰‡ ${uid}... å—ï¼Ÿ`)) return;
        console.log(`ã€${uid}ã€‘å–æ¶ˆå‰:`, await fetchResaleStatus(uid)); 

        try {
          const tx = await contract.cancelResale(uid);
          await tx.wait(); // ç­‰å¾…äº¤æ˜“å®Œæˆ
          
          console.log(`ã€${uid}ã€‘å–æ¶ˆå¾Œ:`, await fetchResaleStatus(uid)); // false
          alert('å¡ç‰‡å–æ¶ˆä¸Šæ¶æˆåŠŸ');
          loadMyCardsSecond(); // é‡æ–°è¼‰å…¥ UI
        } catch (err) {
          console.error('å–æ¶ˆä¸Šæ¶å¤±æ•—:', err);
          alert('å–æ¶ˆä¸Šæ¶å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console log');
        }
      }
      // è¼‰å…¥æˆ‘çš„äº¤æ˜“ç®¡ç† - ä½¿ç”¨ç¾ä»£è¡¨æ ¼æ¨£å¼
      async function loadMyTradesSecond() {
        try {
          const tradesDiv = document.getElementById('my-trades-second');
          tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

          const trades = await contract.getUserTrades(userAccount);

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è§’è‰²</th><th>äº¤æ˜“å°è±¡</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';

            for (const trade of trades) {
              let roleText = '';
              let counterparty = '';
              let actionButton = '';
              let statusText = '';

              if (trade.seller.toLowerCase() === userAccount.toLowerCase()) {
                roleText = 'è³£å®¶';
                counterparty = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'æœªå®š';

                if (trade.status === 1) {
                  actionButton = `<button onclick="sellerSign(${trade.tradeId})" class="btn-success">ç°½ç½²äº¤æ˜“</button>`;
                }
              } else {
                roleText = 'è²·å®¶';
                counterparty = `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}`;

                if (trade.status === 2) {
                  actionButton = `<button onclick="finalize(${trade.tradeId})" class="btn-success">å®Œæˆäº¤æ˜“</button>`;
                }
              }

              switch (trade.status) {
                case 0:
                  statusText = '<span class="trade-status status-created">å·²å‰µå»º</span>';
                  break;
                case 1:
                  statusText = '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
                  break;
                case 2:
                  statusText = '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
                  break;
                case 5:
                  statusText = '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
                  break;
                default:
                  statusText = `<span class="trade-status">ç‹€æ…‹: ${trade.status}</span>`;
              }

              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${roleText}</td>
                <td>${counterparty}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>${statusText}</td>
                <td>${actionButton}</td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•äº¤æ˜“è¨˜éŒ„ã€‚</p>';
          }
        } catch (error) {
          console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶äº¤æ˜“ç®¡ç†å¤±æ•—:", error);
          document.getElementById('my-trades-second').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“ç®¡ç†å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥æ‰€æœ‰äº¤æ˜“æ¦‚è¦½
      async function loadAllTradesOverview() {
        const overviewDiv = document.getElementById('all-trades-overview');
        if (!contract) {
          overviewDiv.innerHTML = '<p>å°šæœªé€£æ¥åˆç´„ã€‚</p>';
          return;
        }
        if (!isOwner) {
          overviewDiv.innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯æŸ¥çœ‹äº¤æ˜“æ¦‚è¦½ã€‚</p>';
          return;
        }

        try {
          overviewDiv.innerHTML = '<p>å·²é€£æ¥åˆç´„å¾…åˆä½µç¨‹å¼</p>';
        } catch (error) {
          console.error("è¼‰å…¥äº¤æ˜“æ¦‚è¦½å¤±æ•—:", error);
          overviewDiv.innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
        }
      }

      // è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æ
      async function loadTradeAnalytics() {
        const analyticsDiv = document.getElementById('trade-analytics');
        if (!contract) {
          analyticsDiv.innerHTML = '<p>å°šæœªé€£æ¥åˆç´„ã€‚</p>';
          return;
        }
        if (!isOwner) {
          analyticsDiv.innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥æŸ¥çœ‹äº¤æ˜“æ•¸æ“šåˆ†æã€‚</p>';
          return;
        }
        try {
          analyticsDiv.innerHTML = '<p>å·²é€£æ¥åˆç´„å¾…åˆä½µç¨‹å¼</p>';
        } catch (error) {
          console.error("è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—:", error);
          analyticsDiv.innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—ã€‚</p>';
        }
      }

      // å°‡æ“ä½œå‡½æ•¸æ›åˆ°windowå°è±¡ä¸Š
      window.purchaseSpecificCard = purchaseSpecificCard;
      window.approveTransfer = approveTransfer;
      window.buyCard = buyCard;
      window.sellerSign = sellerSign;
      window.finalize = finalize;
      window.buyResaleCard = buyResaleCard;
      window.viewCardDetails = viewCardDetails;

      // è¨­ç½®äº‹ä»¶ç›£è½å™¨
      function setupEventListeners() {
        if (!contract) return;

        contract.on("CardPurchased", (buyer, amount, uid) => {
          console.log("æ•ç²åˆ° CardPurchased äº‹ä»¶:", buyer, amount.toString(), uid);

          if (buyer.toLowerCase() === userAccount.toLowerCase()) {
            console.log("ç”¨æˆ¶è³¼è²·å¡ç‰‡ï¼ŒUID:", uid);
            const purchaseStatus = document.getElementById('purchase-status');
            if (purchaseStatus) {
              purchaseStatus.innerHTML = `
              <div class="status success">
                <p>è³¼è²·æˆåŠŸï¼</p>
                <p>è«‹ä½¿ç”¨æƒæå™¨æƒææ‚¨çš„å¡ç‰‡ UIDï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ã€‚</p>
                <p>æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä¾†ç”³è«‹å¡ç‰‡æ‰€æœ‰æ¬Šè½‰ç§»ã€‚</p>
              </div>
            `;
            }

            const uidInput = document.getElementById('card-uid');
            if (uidInput) uidInput.value = uid;
            loadAvailableCardsMarket();
          }
        });
      }

      // è³¼è²·ç‰¹å®šå¡ç‰‡
      async function purchaseSpecificCard(uid, priceWei) {
        const purchaseStatus = document.getElementById('purchase-status');
        try {
          purchaseStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
          purchaseStatus.className = 'status info';

          console.log("æº–å‚™è³¼è²·å¡ç‰‡:", uid);
          console.log("åƒ¹æ ¼(Wei):", priceWei);

          // æ¸…ç†å’Œé©—è­‰ UID - ç§»é™¤å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
          // const cleanUID = uid.trim();

          let valueForTx;
          try {
            valueForTx = ethers.BigNumber.from(priceWei);
          } catch (e) {
            purchaseStatus.innerHTML = `<div class="status error">åƒ¹æ ¼æ ¼å¼éŒ¯èª¤: ${e.message}</div>`;
            return;
          }

          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            purchaseStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
            return;
          }

          const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
          let signerAddress = connectionStatus.textContent.trim();
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            purchaseStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
            return;
          }

          console.log("æ¥æ”¶è€…éŒ¢åŒ…åœ°å€:", signerAddress);
          // console.log("æ¸…ç†å¾Œçš„ UID:", cleanUID);
          console.log("å‚³å…¥ UID:", uid);

          // ä½¿ç”¨æ›´å¤§çš„ gas limit ä»¥é¿å…äº¤æ˜“å¤±æ•—
          const gasLimit = 800000;

          try {
            const returnedUidCheck = await contract.callStatic.purchaseSpecificCard(uid, signerAddress, {
              value: valueForTx,
              gasLimit: gasLimit,
            });
            console.log("æ¨¡æ“¬æˆåŠŸï¼Œè¿”å›UID:", returnedUidCheck);
          } catch (staticError) {
            const reason = ethers.utils.toUtf8String("0x" + err.data.substr(138));
            console.error("åˆçº¦å›é€€åŸå› ï¼š", reason);
            console.warn("æ¨¡æ“¬å¤±æ•—ï¼Œå¯èƒ½äº¤æ˜“æœƒ revert:", staticError);
            // ä¸è¦ç›´æ¥è¿”å›ï¼Œç¹¼çºŒå˜—è©¦å¯¦éš›äº¤æ˜“
          }

          const tx = await contract.purchaseSpecificCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: gasLimit,
          });
          console.log("äº¤æ˜“ç™¼é€:", tx);

          const receipt = await tx.wait();
          console.log("äº¤æ˜“ç¢ºèª:", receipt);

          try {
            const tokenId = await contract.uidToTokenId(uid);
            console.log("å°æ‡‰ tokenId:", tokenId.toString());

            const tx2 = await contract.recordPrimaryTrade(uid, tokenId, signerAddress, valueForTx);
            await tx2.wait();
            console.log("âœ… ä¸€æ‰‹äº¤æ˜“å·²è¨˜éŒ„åˆ° TradeManager");
          } catch (e) {
            console.warn("âš ï¸ ç„¡æ³•è¨˜éŒ„ä¸€æ‰‹äº¤æ˜“:", e.message);
          }

          purchaseStatus.innerHTML = `
          <div class="status success">
            <p>è³¼è²·æˆåŠŸï¼</p>
            <p>è«‹æƒææˆ–è¼¸å…¥å¡ç‰‡ UID</p>
            <p>ä¸¦æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä»¥ç¶ä¸Šã€‚</p>
          </div>
        `;

          const cardUidInput = document.getElementById('card-uid');
          if (cardUidInput) {
            cardUidInput.value = uid;
          }

          await loadAvailableCardsMarket();

        } catch (error) {
          console.error("è³¼è²·å¡ç‰‡å¤±æ•—:", error);
          let errorMessage = error.message || "æœªçŸ¥éŒ¯èª¤";

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = "äº¤æ˜“è¢«ç”¨æˆ¶æ‹’çµ•";
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage = "åˆç´„åŸ·è¡ŒéŒ¯èª¤ï¼Œè«‹ç¢ºèªéŒ¢åŒ…é¤˜é¡æˆ–å¡ç‰‡ç‹€æ…‹";
          } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
            errorMessage = "Gas ä¼°ç®—å¤±æ•—ï¼Œå¯èƒ½æ˜¯åˆç´„ç‹€æ…‹å•é¡Œ";
          } else if (error.message.includes('insufficient funds')) {
            errorMessage = "éŒ¢åŒ…é¤˜é¡ä¸è¶³";
          }

          purchaseStatus.innerHTML = `<div class="status error">è³¼è²·å¡ç‰‡å¤±æ•—: ${errorMessage}</div>`;
        }
      }

      // è³¼è²·äºŒæ‰‹å¡ç‰‡
      async function buyResaleCard(uid, priceWei) {
        const purchaseStatus = document.getElementById('purchase-status');
        try {
          purchaseStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
          purchaseStatus.className = 'status info';

          console.log("æº–å‚™è³¼è²·äºŒæ‰‹å¡ç‰‡:", uid);
          console.log("åƒ¹æ ¼(Wei):", priceWei);

          let valueForTx;
          try {
            valueForTx = ethers.BigNumber.from(priceWei);
          } catch (e) {
            purchaseStatus.innerHTML = `<div class="status error">åƒ¹æ ¼æ ¼å¼éŒ¯èª¤: ${e.message}</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            purchaseStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          let signerAddress = connectionStatus.textContent.trim();
          const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            purchaseStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          console.log("æ¥æ”¶è€…éŒ¢åŒ…åœ°å€:", signerAddress);
          console.log("å‚³å…¥ UID:", uid);

          const tokenId = await contract.uidToTokenId(uid);
          console.log("å°æ‡‰ tokenId:", tokenId.toString());

          const seller = await contract.getNFTHolder(uid);
          console.log("è³£å®¶åœ°å€:", seller);

          try {
            const returnedUidCheck = await contract.callStatic.purchaseResaleCard(uid, signerAddress, {
              value: valueForTx,
              gasLimit: 500000,
            });
            console.log("æ¨¡æ“¬æˆåŠŸï¼Œè¿”å›UID:", returnedUidCheck);
          } catch (staticError) {
            console.warn("æ¨¡æ“¬å¤±æ•—ï¼Œå¯èƒ½äº¤æ˜“æœƒ revert:", staticError);
          }

          const tx = await contract.purchaseResaleCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: 500000,
          });
          console.log("äº¤æ˜“ç™¼é€:", tx);

          const receipt = await tx.wait();
          console.log("äº¤æ˜“ç¢ºèª:", receipt);

          try {
            const tx2 = await contract.recordSecondaryTrade(uid, tokenId, seller, receipt.from, valueForTx);
            await tx2.wait();
            console.log("âœ… äºŒæ‰‹äº¤æ˜“å·²è¨˜éŒ„åˆ° TradeManager");
          } catch (e) {
            console.warn("âš ï¸ ç„¡æ³•è¨˜éŒ„äºŒæ‰‹äº¤æ˜“:", e.message);
          }

          purchaseStatus.innerHTML = `
          <div class="status success">
            <p>è³¼è²·æˆåŠŸï¼</p>
            <p>è«‹æƒææˆ–è¼¸å…¥å¡ç‰‡ UID</p>
            <p>ä¸¦æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä»¥ç¶ä¸Šã€‚</p>
          </div>
        `;

          const cardUidInput = document.getElementById('card-uid');
          if (cardUidInput) {
            cardUidInput.value = uid;
          }

          await loadResaleCardsMarket();

        } catch (error) {
          console.error("è³¼è²·äºŒæ‰‹å¡ç‰‡å¤±æ•—:", error);
          let errorMessage = error.message || "æœªçŸ¥éŒ¯èª¤";

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = "äº¤æ˜“è¢«ç”¨æˆ¶æ‹’çµ•";
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage = "åˆç´„åŸ·è¡ŒéŒ¯èª¤ï¼Œè«‹ç¢ºèªéŒ¢åŒ…é¤˜é¡æˆ–å¡ç‰‡ç‹€æ…‹";
          }

          purchaseStatus.innerHTML = `<div class="status error">è³¼è²·äºŒæ‰‹å¡ç‰‡å¤±æ•—: ${errorMessage}</div>`;
          purchaseStatus.className = 'status error';
        }
      }

      // ç¶å®šå¡ç‰‡
      async function bindCard() {
        const uid = document.getElementById('card-uid').value.trim();
        const requestStatus = document.getElementById('request-status');

        if (!uid) {
          requestStatus.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„å¡ç‰‡ UIDã€‚';
          requestStatus.className = 'status error';
          return;
        }

        try {
          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            requestStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
            requestStatus.className = 'status error';
            return;
          }
          const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
          let signerAddress = connectionStatus.textContent.trim();
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            requestStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
            requestStatus.className = 'status error';
            return;
          }
          requestStatus.innerHTML = '<span>ç¶å®šä¸­... <div class="loader"></div></span>';
          requestStatus.className = 'status info';

          const tx = await contract.bindCardUID(uid, signerAddress);
          await tx.wait();

          requestStatus.textContent = 'ç¶å®šæˆåŠŸï¼æ‚¨çš„å¡ç‰‡å·²å®Œæˆç¶å®šã€‚';
          requestStatus.className = 'status success';
        } catch (error) {
          console.error("ç¶å®šå¡ç‰‡å¤±æ•—:", error);
          let errorMessage = error.message.replace('execution reverted: ', '');
          requestStatus.textContent = 'ç¶å®šå¡ç‰‡å¤±æ•—ï¼š' + errorMessage;
          requestStatus.className = 'status error';
        }
      }

      // ä¸Šæ¶äºŒæ‰‹å¡ç‰‡
      async function resaleCard() {
        const uid = document.getElementById("card-to-sell").value.trim();
        const priceInput = document.getElementById("selling-price").value.trim();
        const statusDiv = document.getElementById("create-trade-status");

        if (!uid || !priceInput) {
          statusDiv.innerHTML = '<div class="status error">è«‹é¸æ“‡å¡ç‰‡ä¸¦è¼¸å…¥åƒ¹æ ¼</div>';
          return;
        }

        try {
          statusDiv.innerHTML = '<span>ä¸Šæ¶ä¸­... <div class="loader"></div></span>';
          statusDiv.className = 'status info';

          const price = ethers.utils.parseEther(priceInput);
          const tx = await contract.listCardForResale(uid, price);

          statusDiv.innerHTML = `<div class="status info">äº¤æ˜“ç™¼é€ä¸­ (tx: ${tx.hash})</div>`;
          await tx.wait();

          statusDiv.innerHTML = '<div class="status success">ä¸Šæ¶æˆåŠŸï¼</div>';

          // é‡æ–°è¼‰å…¥ç›¸é—œæ•¸æ“š
          await loadMyCardsSecond();
          await loadResaleCardsMarket();
        } catch (err) {
          console.error("ä¸Šæ¶å¤±æ•—", err);
          statusDiv.innerHTML = `<div class="status error">ä¸Šæ¶å¤±æ•—ï¼š${err?.reason || err?.message || "æœªçŸ¥éŒ¯èª¤"}</div>`;
        }
      }

      // è³¼è²·å¡ç‰‡ (å¸‚å ´äº¤æ˜“)
      async function buyCard(tradeId, price) {
        try {
          await contract.buyerSign(tradeId, { value: price });
          alert('è³¼è²·æˆåŠŸï¼ç­‰å¾…è³£å®¶ç¢ºèªè½‰ç§»ã€‚');
          loadAvailableTradesFirst();
          loadAvailableTradesSecond();
          loadMyTradesSecond();
        } catch (error) {
          console.error("è³¼è²·å¤±æ•—:", error);
          alert('è³¼è²·å¤±æ•—ï¼š' + error.message.replace('execution reverted: ', ''));
        }
      }

      // è³£å®¶ç°½ç½²
      async function sellerSign(tradeId) {
        try {
          await contract.sellerSign(tradeId);
          alert('è³£å®¶ç°½ç½²æˆåŠŸï¼');
          loadMyTradesSecond();
          loadMySalesFirst();
        } catch (error) {
          console.error("ç°½ç½²å¤±æ•—:", error);
          alert('ç°½ç½²å¤±æ•—ï¼š' + error.message);
        }
      }

      // å®Œæˆäº¤æ˜“
      async function finalize(tradeId) {
        try {
          await contract.finalize(tradeId);
          alert('äº¤æ˜“å®Œæˆï¼');
          loadMyTradesSecond();
        } catch (error) {
          console.error("å®Œæˆäº¤æ˜“å¤±æ•—:", error);
          alert('å®Œæˆäº¤æ˜“å¤±æ•—ï¼š' + error.message);
        }
      }

      // è¨­ç½®å¡ç‰‡åƒ¹æ ¼ (åƒ…ç®¡ç†å“¡)
      async function setCardPrice() {
        if (!isOwner) {
          alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
          return;
        }

        const idolGroup = document.getElementById('idol-group').value.trim();
        const idolMember = document.getElementById('idol-member').value.trim();
        const cardNumber = document.getElementById('card-number').value.trim();
        const listPriceEth = document.getElementById('list-price').value;
        const photoURI = document.getElementById('photo-uri').value.trim();
        const newPriceEth = document.getElementById('new-price').value;
        const amount = document.getElementById('card-amount').value;
        const setPriceStatus = document.getElementById('set-price-status');

        if (!newPriceEth || !idolGroup || !idolMember || !cardNumber || !listPriceEth || !photoURI) {
          setPriceStatus.innerHTML = '<div class="status error">è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰æ¬„ä½ã€‚</div>';
          return;
        }

        try {
          setPriceStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
          setPriceStatus.className = 'status info';

          const newPriceWei = ethers.utils.parseEther(newPriceEth);
          const listPriceWei = ethers.utils.parseEther(listPriceEth);

          const tx = await contract.setCardPrice(
            newPriceWei,
            idolGroup,
            idolMember,
            cardNumber,
            listPriceWei,
            photoURI,
            amount
          );

          await tx.wait();

          setPriceStatus.innerHTML = '<div class="status success">å¡ç‰‡è³‡è¨Šè¨­ç½®æˆåŠŸï¼</div>';

          // æ¸…ç©ºè¡¨å–®
          document.getElementById('idol-group').value = '';
          document.getElementById('idol-member').value = '';
          document.getElementById('card-number').value = '';
          document.getElementById('list-price').value = '';
          document.getElementById('photo-uri').value = '';
          document.getElementById('new-price').value = '';
          document.getElementById('card-amount').value = '';

          // é‡æ–°è¼‰å…¥å¡ç‰‡çµ±è¨ˆ
          await loadCardStats();
        } catch (error) {
          console.error("è¨­ç½®å¡ç‰‡è³‡è¨Šå¤±æ•—:", error);
          setPriceStatus.innerHTML = `<div class="status error">è¨­ç½®å¡ç‰‡è³‡è¨Šå¤±æ•—ï¼š${error.message.replace('execution reverted: ', '')}</div>`;
        }
      }

      // å¯©æ‰¹å¡ç‰‡è«‹æ±‚ (åƒ…ç®¡ç†å“¡)
      async function approveTransfer(uid) {
        if (!isOwner) {
          alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
          return;
        }

        try {
          await contract.approveTransfer(uid);
          alert('å¯©æ‰¹æˆåŠŸï¼');
          loadPendingRequests();
        } catch (error) {
          console.error("å¯©æ‰¹å¤±æ•—:", error);
          alert('å¯©æ‰¹å¤±æ•—ï¼š' + error.message.replace('execution reverted: ', ''));
        }
      }

      // æ‹’çµ•å¡ç‰‡è«‹æ±‚ (åƒ…ç®¡ç†å“¡)
      async function rejectTransfer(uid) {
        if (!isOwner) {
          alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
          return;
        }

        try {
          await contract.rejectTransfer(uid);
          alert('å·²æ‹’çµ•æ­¤è«‹æ±‚ï¼');
          loadPendingRequests();
        } catch (error) {
          console.error("æ‹’çµ•è«‹æ±‚å¤±æ•—:", error);
          alert('æ‹’çµ•è«‹æ±‚å¤±æ•—ï¼š' + error.message);
        }
      }

      // æŸ¥çœ‹å¡ç‰‡è©³æƒ…
      async function viewCardDetails(uid) {
        console.log("ğŸ” æŸ¥è©¢äº¤æ˜“ç´€éŒ„ for UID:", uid);
        const modal = document.getElementById('card-modal');
        const content = document.getElementById('card-modal-content');
        modal.style.display = 'flex';
        content.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        try {
          console.log("ğŸ” æŸ¥çœ‹å¡ç‰‡è©³æƒ…ï¼ŒUID:", uid);

          if (!contract) {
            content.innerHTML = '<p class="error">åˆç´„å°šæœªé€£æ¥ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</p>';
            return;
          }

          console.log("ğŸš€ å‘¼å« getTradesByUID...");
          const trades = await contract.getTradesByUID(uid);
          console.log("âœ… æˆåŠŸå–å¾—äº¤æ˜“è³‡æ–™:", trades);

          if (!trades || trades.length === 0) {
            content.innerHTML = `
            <h3>å¡ç‰‡è©³æƒ…</h3>
            <p>â—ï¸ æ­¤å¡ç‰‡å°šæœªæœ‰äº¤æ˜“ç´€éŒ„ã€‚</p>
            <p><em>æç¤ºï¼šå¦‚æœé€™æ˜¯å‰›è³¼è²·çš„å¡ç‰‡ï¼Œäº¤æ˜“ç´€éŒ„å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ‰æœƒå‡ºç¾ã€‚</em></p>
          `;
            return;
          }

          let html = `
          <h3>å¡ç‰‡äº¤æ˜“æ­·å²</h3>
          <table class="modern-table">
            <thead>
              <tr><th>äº¤æ˜“ ID</th><th>è²·å®¶</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ™‚é–“</th></tr>
            </thead>
            <tbody>
        `;

          for (const trade of trades) {
            const buyer = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'â€”';
            const seller = trade.seller ? `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}` : 'â€”';
            const priceEth = ethers.utils.formatEther(trade.price);
            const time = trade.timestamp > 0 ? new Date(trade.timestamp * 1000).toLocaleString() : 'â€”';
            const statusText = getStatusLabel(trade.status);

            html += `<tr>
            <td>#${trade.tradeId}</td>
            <td>${buyer}</td>
            <td>${seller}</td>
            <td>${priceEth} ETH</td>
            <td>${statusText}</td>
            <td>${time}</td>
          </tr>`;
          }

          html += `</tbody></table>`;
          content.innerHTML = html;

        } catch (err) {
          console.error("âŒ è¼‰å…¥äº¤æ˜“è©³æƒ…å¤±æ•—:", err);
          content.innerHTML = `
          <h3>éŒ¯èª¤è©³æƒ…</h3>
          <p class="error">ç„¡æ³•å–å¾—äº¤æ˜“ç´€éŒ„</p>
          <details>
            <summary>æŠ€è¡“ç´°ç¯€</summary>
            <pre>${err.message}</pre>
          </details>
          <p><em>è«‹ç¢ºèªï¼š</em></p>
          <ul>
            <li>åˆç´„æ˜¯å¦æ­£ç¢ºéƒ¨ç½²</li>
            <li>UID æ˜¯å¦æ­£ç¢º</li>
            <li>æ˜¯å¦æœ‰æ¬Šé™å­˜å–æ­¤è³‡æ–™</li>
          </ul>
        `;
        }
      }

      // ç²å–ç‹€æ…‹æ¨™ç±¤
      function getStatusLabel(status) {
        const baseStyle = 'white-space: nowrap; display: inline-block; min-width: 70px; text-align: center; padding: 0.5rem 1rem;';

        switch (status) {
          case 0: return '<span class="trade-status status-created">å·²å‰µå»º</span>';
          case 1: return '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
          case 2: return '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
          case 5: return '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
          default: return `<span class="trade-status">ç‹€æ…‹ ${status}</span>`;
        }
      }

      // åˆå§‹åŒ–æ¨™ç±¤é åˆ‡æ›
      function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active é¡
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            // ç‚ºç•¶å‰æ¨™ç±¤é æ·»åŠ  active é¡
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');

            // å¦‚æœåˆ‡æ›åˆ°éå¾€äº¤æ˜“ tabï¼Œè¼‰å…¥è¨˜éŒ„
            if (tabId === 'history' && contract && userAccount) {
              loadHistoryRecords();
            }
          });
        });
      }

      // é—œé–‰æ¨¡æ…‹æ¡†
      document.getElementById('card-modal-close').addEventListener('click', () => {
        const modal = document.getElementById('card-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      });

      // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
      document.getElementById('card-modal').addEventListener('click', (e) => {
        if (e.target.id === 'card-modal') {
          e.target.style.display = 'none';
        }
      });

      // å°‡ rejectTransfer æ·»åŠ åˆ° window å°è±¡
      window.rejectTransfer = rejectTransfer;

      // æ¸¬è©¦åˆç´„åŠŸèƒ½
      async function testContractFunctions() {
        console.log("é–‹å§‹æ¸¬è©¦åˆç´„åŠŸèƒ½...");

        try {
          console.log("åˆç´„å¯¦ä¾‹:", contract);
          console.log("åˆç´„ ABI:", contractABI);

          console.log("å˜—è©¦ç²å–å¯ç”¨å¡ç‰‡...");
          const cards = await contract.getAvailableCards();
          console.log("å¯ç”¨å¡ç‰‡:", cards);

          console.log("æª¢æŸ¥äº‹ä»¶å®šç¾©...");
          const filter = contract.filters.CardPurchased();
          console.log("CardPurchased äº‹ä»¶éæ¿¾å™¨:", filter);

          const balance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [userAccount, 'latest']
          });
          console.log("éŒ¢åŒ…é¤˜é¡:", ethers.utils.formatEther(balance), "ETH");

          console.log("æ¸¬è©¦å®Œæˆ");
        } catch (error) {
          console.error("åˆç´„åŠŸèƒ½æ¸¬è©¦å¤±æ•—:", error);
        }
      }

      // å°‡æ¸¬è©¦å‡½æ•¸æ·»åŠ åˆ° window å°è±¡
      window.testContractFunctions = testContractFunctions;
      window.testGetResaleCards = async function () {
        const cards = await contract.getResaleCards();
        console.log("äºŒæ‰‹å¡ç‰‡ï¼š", cards);
      };

      let cardManagerContract;

      async function checkCardManagerOwner() {
        if (!contract || !userAccount) {
          console.log("åˆç´„æˆ–ç”¨æˆ¶å¸³è™Ÿå°šæœªåˆå§‹åŒ–");
          return;
        }

        try {
          const cardManagerAbi = [
            "function owner() view returns (address)"
          ];

          const provider = contract.provider;
          const signer = provider.getSigner(userAccount);

          const cardManagerContract = new ethers.Contract(cardManagerAddress, cardManagerAbi, signer);

          const ownerAddress = await cardManagerContract.owner();
          console.log("CardManager åˆç´„æ“æœ‰è€…:", ownerAddress);
          console.log("ç›®å‰éŒ¢åŒ…åœ°å€:", userAccount);

          if (ownerAddress.toLowerCase() === userAccount.toLowerCase()) {
            console.log("ä½ æ˜¯ CardManager çš„æ“æœ‰è€…ï¼Œå¯ä»¥åŸ·è¡Œç®¡ç†æ“ä½œã€‚");
          } else {
            console.warn("ä½ ä¸æ˜¯ CardManager çš„æ“æœ‰è€…ï¼Œç®¡ç†æ“ä½œæœƒè¢«æ‹’çµ•ï¼");
          }
        } catch (error) {
          console.error("æª¢æŸ¥ CardManager æ“æœ‰è€…å¤±æ•—:", error);
        }
      }
    </script>
</body>

</html>