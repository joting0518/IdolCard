<!DOCTYPE html>
<html lang="zh-TW">

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¶åƒå¡ç‰‡ç³»çµ±</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f9f9f9;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      flex: 1;
      min-width: 300px;
    }

    h1,
    h2,
    h3 {
      color: #4a148c;
    }

    button {
      background: #4a148c;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .role-switcher {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .role-btn {
      flex: 1;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      padding: 12px 15px;
      transition: all 0.3s ease;
    }

    .role-btn:hover {
      background: #e0e0e0;
    }

    .role-active {
      background: #4a148c;
      color: white;
      border-color: #4a148c;
    }

    .role-active:hover {
      background: #6a1b9a;
    }

    .connect-btn {
      background: #6a1b9a;
      font-weight: bold;
      padding: 12px 20px;
    }

    .connect-btn:hover {
      background: #8e24aa;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 16px;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }

    .info {
      background: #e3f2fd;
      color: #1565c0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #4a148c;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
    }

    .tab.active {
      border-bottom: 3px solid #4a148c;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .trade-status {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      display: inline-block;
    }

    .status-created {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-buyer-signed {
      background: #fff3e0;
      color: #e65100;
    }

    .status-seller-signed {
      background: #f1f8e9;
      color: #558b2f;
    }

    .status-completed {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a148c;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 2s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .tabs,
    .tab-content,
    .container {
      display: none;
    }
  </style>
</head>

<body>
  <h1>å¶åƒå¡ç‰‡ç³»çµ±</h1>

  <div class="card" style="margin-bottom: 20px;">
    <h2>éŒ¢åŒ…é€£æ¥</h2>
    <button id="connectWalletBtn" class="connect-btn">é€£æ¥éŒ¢åŒ…</button>
    <div id="connection-status" class="status info" style="margin-top: 10px;">è«‹é€£æ¥æ‚¨çš„éŒ¢åŒ…ä»¥ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½</div>
  </div>
  <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <button id="walletBalanceBtn" style="background: none; border: none; cursor: pointer; padding: 0;">
      <img src="./wallet.webp" alt="æŸ¥çœ‹éŒ¢åŒ…é¤˜é¡" style="width: 40px; height: 40px;">
    </button>
  </div>
  

  <!-- <div class="card" style="margin-bottom: 20px;">
    <h2>è§’è‰²åˆ‡æ›</h2>
    <div class="role-switcher">
      <button id="role-company" class="role-btn role-active">å…¬å¸</button>
      <button id="role-buyer" class="role-btn">æ™®é€šç”¨æˆ¶</button>
    </div>
    <div id="role-description" class="status info" style="margin-top: 10px;">
      ç•¶å‰è§’è‰²: å…¬å¸ - è² è²¬ç™¼è¡Œå¡ç‰‡å’Œå¯©æ‰¹å¡ç‰‡ç¶å®šè«‹æ±‚
    </div>
  </div> -->

  <div class="tabs">
    <div class="tab active" data-tab="purchase">ç™¼è¡Œå¡ç‰‡</div>
    <div class="tab" data-tab="myCards">æˆ‘çš„å¡ç‰‡</div>
    <div class="tab" data-tab="market">å¸‚å ´äº¤æ˜“</div>
    <div class="tab" data-tab="admin">ç®¡ç†åŠŸèƒ½</div>
    <div class="tab" data-tab="history">éå¾€äº¤æ˜“</div>
  </div>

  <div class="container">
    <!-- è³¼è²·å¡ç‰‡ Tab -->
    <div id="purchase" class="tab-content active">
      <!-- å…¬å¸è§’è‰² -->
      <div class="role-content company-role">
        <div class="card">
          <h2>è¨­ç½®å¡ç‰‡è³‡è¨Šèˆ‡åƒ¹æ ¼</h2>
          <input type="text" id="idol-group" placeholder="å¶åƒåœ˜é«”åç¨± (e.g., BTS)">
          <input type="text" id="idol-member" placeholder="æˆå“¡å§“å (e.g., Jungkook)">
          <input type="text" id="card-number" placeholder="å¡ç‰‡ç·¨è™Ÿ (e.g., 001)">
          <input type="number" id="list-price" placeholder="å¡ç‰‡ä¸Šæ¶åƒ¹ (ETH)" step="0.001">
          <input type="text" id="photo-uri" placeholder="ç…§ç‰‡ URI (e.g., ipfs://xxx)">
          <input type="number" id="new-price" placeholder="åˆç´„å…§éƒ¨åƒ¹æ ¼ (ETH)" step="0.001">
          <input type="number" id="card-amount" placeholder="ç™¼è¡Œå¼µæ•¸ (e.g., 10)">
          <button id="set-price-btn">è¨­ç½®å¡ç‰‡è³‡è¨Š</button>
          <div id="set-price-status"></div>
        </div>

      </div>

      <!-- æ™®é€šç”¨æˆ¶è§’è‰² -->
      <div class="role-content buyer-role" style="display: none;">
        <div class="card">
          <h2>ç€è¦½å¯è³¼è²·å¡ç‰‡</h2>

          <h3>å…¬å¸è²©å”®å¡ç‰‡</h3>
          <div id="available-cards-market">
            <p>è¼‰å…¥ä¸­...</p>
          </div>

          <h3>è½‰å”®å¡ç‰‡</h3>
          <div id="resale-cards-market">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>


        <div class="card">
          <h2>ç¶å®šå¡ç‰‡ UID</h2>
          <input type="text" id="card-uid" placeholder="è¼¸å…¥å¡ç‰‡ UID">
          <button id="request-card-btn">è«‹æ±‚ç¶å®š</button>
          <div id="request-status"></div>
        </div>
      </div>

      <!-- éš±è—çš„ç‹€æ…‹å€åŸŸï¼Œç”¨æ–¼é¡¯ç¤ºè³¼è²·çµæœ -->
      <div id="purchase-status" class="card" style="margin-top: 20px;"></div>
    </div>

    <!-- æˆ‘çš„å¡ç‰‡ Tab -->
    <div id="myCards" class="tab-content">
      <!-- å…¬å¸è§’è‰² -->
      <div class="role-content company-role">
        <div class="card">
          <h2>å¡ç‰‡ç™¼è¡Œçµ±è¨ˆ</h2>
          <div id="card-stats">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ç¬¬ä¸€æ‰‹è²·å®¶è§’è‰² -->
      <div class="role-content buyer-role" style="display: none;">
        <div class="card">
          <h2>æ“æœ‰å¡ç‰‡</h2>
          <div id="my-cards-list-first">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶è§’è‰² -->
      <div class="role-content second-hand-role" style="display: none;">
        <div class="card">
          <h2>ä¸Šæ¶å¡ç‰‡</h2>
          <div id="my-cards-list-second">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>

        <div class="card">
          <h2>å‰µå»ºäº¤æ˜“</h2>
          <select id="card-to-sell">
            <option value="">-- é¸æ“‡å¡ç‰‡ --</option>
          </select>
          <input type="number" id="selling-price" placeholder="éŠ·å”®åƒ¹æ ¼ (ETH)" step="0.01">
          <button id="resale-btn">ä¸Šæ¶äºŒæ‰‹å¡ç‰‡</button>
          <div id="create-trade-status"></div>
        </div>
      </div>
    </div>

    <!-- å¸‚å ´äº¤æ˜“ Tab -->
    <div id="market" class="tab-content">
      <!-- å…¬å¸è§’è‰² -->
      <div class="role-content company-role">
        <div class="card">
          <h2>æ‰€æœ‰äº¤æ˜“æ¦‚è¦½</h2>
          <div id="all-trades-overview">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ç¬¬ä¸€æ‰‹è²·å®¶è§’è‰² -->
      <div class="role-content buyer-role" style="display: none;">
        <div class="card">
          <h2>å¯ç”¨äº¤æ˜“</h2>
          <div id="available-trades-first">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>

        <div class="card">
          <h2>æˆ‘çš„éŠ·å”®</h2>
          <div id="my-sales-first">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶è§’è‰² -->
      <div class="role-content second-hand-role" style="display: none;">
        <div class="card">
          <h2>å¯ç”¨äº¤æ˜“</h2>
          <div id="available-trades-second">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>

        <div class="card">
          <h2>æˆ‘çš„äº¤æ˜“ç®¡ç†</h2>
          <div id="my-trades-second">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†åŠŸèƒ½ Tab -->
    <div id="admin" class="tab-content">
      <!-- å…¬å¸è§’è‰² -->
      <div class="role-content company-role">
        <div class="card">
          <h2>å¯©æ‰¹å¡ç‰‡è«‹æ±‚</h2>
          <div id="pending-requests">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>

        <div class="card">
          <h2>äº¤æ˜“æ•¸æ“šåˆ†æ</h2>
          <div id="trade-analytics">
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- å…¶ä»–è§’è‰²ç„¡ç®¡ç†åŠŸèƒ½ -->
      <div class="role-content buyer-role" style="display: none;">
        <div class="card">
          <h2>ç„¡ç®¡ç†æ¬Šé™</h2>
          <p>æ‚¨ç›®å‰çš„è§’è‰²ç„¡æ³•è¨ªå•ç®¡ç†åŠŸèƒ½ï¼Œè«‹åˆ‡æ›åˆ°ã€Œå…¬å¸ã€è§’è‰²ã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initEthers, signer } from './js/ethers-init.js';

    // åˆç´„ ABI (æ ¹æ“šå¯¦éš›åˆç´„èª¿æ•´)
    const contractABI = [
      "function owner() external view returns (address)",
      "event CardPurchased(address indexed buyer, uint256 amount, string uid)",
      "event CardRequested(address indexed buyer, string uid)",
      "event CardApproved(string uid, address indexed buyer, uint256 tokenId)",
      "event CardRequestRejected(string uid, address buyer)",

      // CardManager ç›¸é—œå‡½å¼
      "function cardManager() view returns (address)",
      "function getCompanyCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
      "function getAvailableCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
      "function getPendingCardRequests() external view returns (tuple(string uid, address buyer, uint256 amount, uint256 timestamp)[])",
      "function getUserCards(address user) external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
      "function purchaseSpecificCard(string uid, address recipient) external payable returns (string)",
      "function bindCardUID(string uid, address recipient) external",
      "function getCardPrice() external view returns (uint256)",
      "function requestCard(string uid, address recipient) external",
      "function approveTransfer(string uid) external",
      "function rejectTransfer(string uid) external",
      "function setCardPrice(uint256 newPrice, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, uint256 amount) external returns (string)",
      "function listCardForResale(string uid, uint256 price) external",
      "function getNFTHolder(string memory uid) external view returns (address)",
      "function getResaleCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",

      // TradeManager ç›¸é—œå‡½å¼
      "function tradeManager() view returns (address)",
      "function createTrade(string uid, uint256 price) external",
      "function buyerSign(uint256 tradeId) external payable",
      "function sellerSign(uint256 tradeId) external",
      "function finalize(uint256 tradeId) external",
      "function getUserTrades(address user) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
      "function getTradeAnalytics() external view returns (uint256 totalTrades, uint256 completedTrades, uint256 pendingTrades, uint256 totalVolume)",
      "function getAvailableTrades() external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
      "function getTrade(uint256 tradeId) external view returns (uint256 tokenId, address seller, address buyer, uint256 price, uint8 status, uint256 deadline)",
      "function uidToTradeIds(string) view returns (uint256[])",
      "function getTradesByUID(string memory uid) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
      "function tradeCounter() view returns (uint256)",
      "function recordPrimaryTrade(string memory uid, uint256 tokenId, address buyer, uint256 price) external",
      "function recordSecondaryTrade(string memory uid, uint256 tokenId, address seller, address buyer, uint256 price) external",
      "function setUidToTokenId(string memory uid, uint256 tokenId) external",
      "function uidToTokenId(string) view returns (uint256)",
      "function purchaseResaleCard(string uid,address recipient) external payable"
    ];



    // åˆç´„åœ°å€ (éœ€è¦æ›¿æ›ç‚ºå¯¦éš›éƒ¨ç½²çš„åœ°å€) remix deployå®Œæˆä»¥å¾ŒæŠŠdeployed contractçš„åœ°å€è²¼éä¾†
    //const contractAddress = "0x322619fcCcc741880ee7071cBE4e877Fb919eCf8";

    // ç‹€æ…‹è®Šæ•¸
    let contract;
    let userAccount;
    let isOwner = false;
    let contractAddress; // å®£å‘Šç‚ºå…¨åŸŸè®Šæ•¸
    let cardManagerAddress;
    let tradeManagerAddress;

    // DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    window.addEventListener('DOMContentLoaded', () => {
      fetch('./contract-addresses.json')
        .then(res => {
          console.log("âœ… æˆåŠŸ fetch contract-addresses.json");
          return res.json();
        })
        .then(async (addresses) => {
          console.log("âœ… JSON å…§å®¹ç‚º", addresses);

          contractAddress = addresses.IdolCardSystem;
          cardManagerAddress = addresses.CardManager;
          tradeManagerAddress = addresses.TradeManager;
        }
        )
        .catch(err => {
          console.error("éŒ¯èª¤äº†!", err);
        });

      // åˆå§‹åŒ–æ¨™ç±¤é åˆ‡æ›
      initTabs();

      // ç²å–é€£æ¥éŒ¢åŒ…æŒ‰éˆ•
      const connectBtn = document.getElementById('connectWalletBtn');
      if (!connectBtn) return;

      // åˆå§‹é»æ“Šç¶å®š
      connectBtn.addEventListener('click', connectWallet);

      // ç¶å®šè§’è‰²åˆ‡æ›æŒ‰éˆ•
      // document.getElementById('role-company').addEventListener('click', () => switchRole('company'));
      // document.getElementById('role-buyer').addEventListener('click', () => switchRole('buyer'));

      // ç¶å®šå…¶ä»–æŒ‰éˆ•äº‹ä»¶ï¼Œä½†æš«æ™‚ç¦ç”¨
      const buttons = document.querySelectorAll('button:not(#connectWalletBtn):not(.role-btn)');
      buttons.forEach(btn => {
        btn.disabled = true;
      });

      // å„è§’è‰²åŠŸèƒ½æŒ‰éˆ•äº‹ä»¶
      // å…¬å¸è§’è‰²
      document.getElementById('set-price-btn').addEventListener('click', setCardPrice);

      // ç¬¬ä¸€æ‰‹è²·å®¶è§’è‰²
      document.getElementById('request-card-btn').addEventListener('click', bindCard);

      // ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶è§’è‰²
      document.getElementById('create-trade-btn').addEventListener('click', createTrade);
    });

    document.getElementById('walletBalanceBtn').addEventListener('click', async () => {
    if (!userAccount) {
      alert('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
      return;
    }
    try {
      const balanceWei = await window.ethereum.request({
        method: 'eth_getBalance',
        params: [userAccount, 'latest']
      });
      const balanceEth = ethers.utils.formatEther(balanceWei);
      alert(`ç›®å‰çš„é¤˜é¡æ˜¯ ${balanceEth} ETH`);
    } catch (error) {
      console.error("æŸ¥è©¢é¤˜é¡å¤±æ•—:", error);
      alert('æŸ¥è©¢é¤˜é¡å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
    }
  });
    // ç•¶å‰é¸æ“‡çš„è§’è‰²
    let currentRole = 'company';

    // åˆ‡æ›è§’è‰²
    function switchRole(role) {
      // æ›´æ–°ç•¶å‰è§’è‰²
      currentRole = role;

      // æ›´æ–°è§’è‰²æŒ‰éˆ•ç‹€æ…‹
      // document.querySelectorAll('.role-btn').forEach(btn => {
      //   btn.classList.remove('role-active');
      // });

      let roleDescription = '';

      switch (role) {
        case 'company':
          roleDescription = 'ç•¶å‰è§’è‰²: å…¬å¸ - è² è²¬ç™¼è¡Œå¡ç‰‡å’Œå¯©æ‰¹å¡ç‰‡ç¶å®šè«‹æ±‚';
          document.querySelector('.tab[data-tab="purchase"]').textContent = 'ç™¼è¡Œå¡ç‰‡';
          break;
        case 'buyer':
          roleDescription = 'ç•¶å‰è§’è‰²: æ™®é€šç”¨æˆ¶ - å¯ä»¥è³¼è²·å¡ç‰‡ã€è«‹æ±‚ç¶å®šèˆ‡å¸‚å ´äº¤æ˜“';
          document.querySelector('.tab[data-tab="purchase"]').textContent = 'è³¼è²·å¡ç‰‡';
          break;

      }

      // æ›´æ–°è§’è‰²æè¿°
      // document.getElementById('role-description').textContent = roleDescription;

      // æ›´æ–°å…§å®¹é¡¯ç¤º
      document.querySelectorAll('.role-content').forEach(content => {
        content.style.display = 'none';
      });

      if (role === 'company') {
        // åªé¡¯ç¤ºå…¬å¸è§’è‰²çš„å…§å®¹
        document.querySelectorAll('.company-role').forEach(content => {
          content.style.display = 'block';
        });
      } else {
        // åªé¡¯ç¤ºç”¨æˆ¶è§’è‰²çš„å…§å®¹  
        document.querySelectorAll('.buyer-role').forEach(content => {
          content.style.display = 'block';
        });
      }

      // å¦‚æœéŒ¢åŒ…å·²é€£æ¥ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰è§’è‰²çš„æ•¸æ“š
      if (contract && userAccount) {
        loadRoleSpecificData(role);
      }
    }
    async function awaitContractsReady() {
      while (!contractAddress || !cardManagerAddress || !tradeManagerAddress) {
        console.log("â³ ç­‰å¾…åˆç´„åœ°å€è¼‰å…¥...");
        await new Promise(resolve => setTimeout(resolve, 200)); // æ¯ 200ms æª¢æŸ¥ä¸€æ¬¡
      }
      console.log("âœ… åˆç´„åœ°å€å·²æº–å‚™å¥½");
    }


    // é€£æ¥éŒ¢åŒ…
    async function connectWallet() {
      await awaitContractsReady();

      const connectBtn = document.getElementById('connectWalletBtn');
      const connectionStatus = document.getElementById('connection-status');

      try {
        connectionStatus.innerHTML = '<span>é€£æ¥ä¸­... <div class="loader"></div></span>';
        connectionStatus.className = 'status info';

        const result = await initEthers(contractABI, contractAddress);
        contract = result.contract;
        userAccount = result.userAddress;
        console.log("ä½¿ç”¨è€…å¸³æˆ¶:", userAccount);
        console.log("åˆç´„æ˜¯å¦é€£æ¥æˆåŠŸï¼Ÿ", contract);

        connectBtn.textContent = `å·²é€£æ¥: ${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
        connectionStatus.textContent = `å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š${userAccount}`;
        connectionStatus.className = 'status success';

        // æª¢æŸ¥æ˜¯å¦ç‚ºåˆç´„æ“æœ‰è€…
        const owner = await contract.owner();
        isOwner = (owner.toLowerCase() === userAccount.toLowerCase());
        console.log("ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç‚ºæ“æœ‰è€…ï¼Ÿ", isOwner);
        console.log("ä½¿ç”¨çš„åˆç´„åœ°å€:", contractAddress);

        // é¡¯ç¤ºæˆ–éš±è—ç®¡ç†å“¡é ç±¤
        const adminTab = document.querySelector('.tab[data-tab="admin"]');
        if (isOwner) {
          if (adminTab) adminTab.style.display = 'block';
          // ç›´æ¥åˆ‡æ›è§’è‰²ç‚ºå…¬å¸ï¼ˆæ“æœ‰è€…ï¼‰
          currentRole = 'company';
        } else {
          if (adminTab) adminTab.style.display = 'none';
          // åˆ‡æ›è§’è‰²ç‚ºè²·å®¶ï¼ˆéæ“æœ‰è€…ï¼‰
          currentRole = 'buyer';
        }

        // æ§åˆ¶é¡¯ç¤ºå…¬å¸è§’è‰²æˆ–è²·å®¶è§’è‰²å…§å®¹
        if (isOwner) {
          document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'none');
          document.querySelectorAll('.company-role').forEach(el => el.style.display = 'block');
        } else {
          document.querySelectorAll('.company-role').forEach(el => el.style.display = 'none');
          document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'block');
          await loadResaleCardsMarket();

        }

        // é¡¯ç¤ºæ¨™ç±¤èˆ‡å®¹å™¨
        const tabsContainer = document.querySelector('.tabs');
        const mainContainer = document.querySelector('.container');
        if (tabsContainer) tabsContainer.style.display = 'flex';
        if (mainContainer) mainContainer.style.display = 'flex';

        // å•Ÿç”¨é™¤é€£æ¥æŒ‰éˆ•å¤–æ‰€æœ‰æŒ‰éˆ•
        document.querySelectorAll('button:not(#connectWalletBtn)').forEach(btn => btn.disabled = false);

        // åªåœ¨ç¢ºå®šèº«ä»½å¾Œï¼Œæ‰è¼‰å…¥è³‡æ–™
        await loadRoleSpecificData(currentRole);

        // ç›£è½å¸³æˆ¶è®Šå‹•äº‹ä»¶ï¼Œåˆ·æ–°é é¢
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', () => {
            window.location.reload();
          });
        }

        // è¨­å®šåˆç´„äº‹ä»¶ç›£è½å™¨
        setupEventListeners();

      } catch (error) {
        console.error("é€£æ¥ MetaMask å¤±æ•—:", error);
        connectionStatus.textContent = 'é€£æ¥éŒ¢åŒ…å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
        connectionStatus.className = 'status error';
      }
    }


    // æ ¹æ“šè§’è‰²è¼‰å…¥ç‰¹å®šæ•¸æ“š
    async function loadRoleSpecificData(role) {
      try {
        // ç²å–å¡ç‰‡åƒ¹æ ¼ï¼ˆå„è§’è‰²éƒ½éœ€è¦ï¼‰
        const priceWei = await contract.getCardPrice();
        const priceEth = ethers.utils.formatEther(priceWei);

        // æ›´æ–°å„è§’è‰²é¡¯ç¤ºçš„åƒ¹æ ¼
        const priceElement = document.getElementById('card-price');
        if (priceElement) {
          priceElement.textContent = `å¡ç‰‡åƒ¹æ ¼: ${priceEth} ETH`;
        }
        // æ ¹æ“šè§’è‰²è¼‰å…¥ä¸åŒæ•¸æ“š
        switch (role) {
          case 'company':
            // è¼‰å…¥å¾…å¯©æ‰¹è«‹æ±‚
            if (isOwner) {
              loadPendingRequests();
              loadCardStats();
              loadAllTradesOverview();
              loadTradeAnalytics();
              document.querySelector('.tab[data-tab="purchase"]').textContent = 'ç™¼è¡Œå¡ç‰‡';
            }
            break;

          case 'buyer':
            loadMyCardsSecond(); // âœ é¡¯ç¤ºå¡ç‰‡èˆ‡éŠ·å”®
            loadAvailableTradesSecond(); // âœ é¡¯ç¤ºå¸‚å ´äº¤æ˜“
            loadMyTradesSecond(); // âœ æˆ‘çš„äº¤æ˜“ç®¡ç†
            loadAvailableCardsMarket(); // âœ å…¬å¸å¡ç‰‡å¸‚å ´
            loadMyCardsFirst(); // âœ… é¡¯ç¤ºç¶å®šä¸­å¡ç‰‡
            loadAvailableTradesFirst(); // âœ… é¡¯ç¤ºæ›å–®äº¤æ˜“ï¼ˆä¿ç•™ï¼‰
            loadMySalesFirst(); // âœ… é¡¯ç¤ºè‡ªå·±æ›çš„å–®
            document.querySelector('.tab[data-tab="purchase"]').textContent = 'è³¼è²·å¡ç‰‡';
            break;

        }
      } catch (error) {
        console.error(`è¼‰å…¥${role}è§’è‰²æ•¸æ“šå¤±æ•—:`, error);
      }
    }
    async function loadHistoryRecords() {
      try {
        let historyDiv;
        if (currentRole === 'company') {
          historyDiv = document.getElementById('history-records-company');
          historyDiv.style.minHeight = '500px'; 
        } else {
          historyDiv = document.getElementById('history-records-buyer');
          historyDiv.style.minHeight = '500px'; 
        }
        if (!historyDiv) {
          console.error('âŒ æ‰¾ä¸åˆ° historyDiv å…ƒç´ ï¼');
          return;
        }
        console.log("ğŸ” historyDiv å–å¾—æˆåŠŸ:", historyDiv);
        historyDiv.style.display = 'block'; 
        historyDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';
        historyDiv.style.border = '2px solid red'; // ğŸ”¥ Debugç”¨ï¼Œç›´æ¥ç´…æ¡†çœ‹å¾—å‡ºä¾†

        if (!cardManagerContract) {
          historyDiv.innerHTML = '<p class="error">å°šæœªé€£æ¥åˆç´„ã€‚</p>';
          return;
        }

        const currentBlock = await contract.provider.getBlockNumber();
        const fromBlock = 0; // æ‹‰å…¨æ­·å²

        let purchaseFilter, approveFilter;

        if (currentRole === 'company') {
          purchaseFilter = cardManagerContract.filters.CardPurchased();
          approveFilter = cardManagerContract.filters.CardApproved();
        } else {
          purchaseFilter = cardManagerContract.filters.CardPurchased(userAccount);
          approveFilter = cardManagerContract.filters.CardApproved(null, userAccount);
        }

        const purchaseEvents = await cardManagerContract.queryFilter(purchaseFilter, fromBlock, 'latest');
        const approveEvents = await cardManagerContract.queryFilter(approveFilter, fromBlock, 'latest');
        console.log("ğŸ§¾ æ‰¾åˆ°å¤šå°‘è³¼è²·ç´€éŒ„ï¼Ÿ", purchaseEvents.length);
        console.log("ğŸ§¾ æ‰¾åˆ°å¤šå°‘å¯©æ‰¹ç´€éŒ„ï¼Ÿ", approveEvents.length);

        let records = [];

        for (let i = 0; i < purchaseEvents.length; i++) {
          const event = purchaseEvents[i];
          records.push({
            blockNumber: event.blockNumber,
            event: `è³¼è²·å¡ç‰‡ï¼ŒUID: ${event.args[2]}, è³¼è²·è€…: ${event.args[0]}`,
          });
        }

        for (let i = 0; i < approveEvents.length; i++) {
          const event = approveEvents[i];
          records.push({
            blockNumber: event.blockNumber,
            event: `å¡ç‰‡å¯©æ‰¹é€šéï¼ŒUID: ${event.args[0]}, è²·å®¶: ${event.args[1]}`,
          });
        }

        records.sort((a, b) => b.blockNumber - a.blockNumber);

        if (records.length > 0) {
          console.log("ğŸ“š records length", records.length);
          let html = '<table><thead><tr><th>å€å¡Šè™Ÿ</th><th>äº‹ä»¶</th></tr></thead><tbody>';

          for (let i = 0; i < records.length; i++) {
            const record = records[i];
            html += `<tr><td>${record.blockNumber}</td><td>${record.event}</td></tr>`;
          }

          html += '</tbody></table>';
          html += `<p>ğŸ“Œ å…± ${records.length} ç­†ç´€éŒ„</p>`; // ğŸ”¥ é¡¯ç¤ºç¸½ç­†æ•¸

          historyDiv.innerHTML = html;
          historyDiv.offsetHeight; 
          
          console.log('âœ… å·²æˆåŠŸå¡å…¥ HTML å…§å®¹:');
          console.log(historyDiv.innerHTML); // ğŸ”¥ ç›´æ¥å°å‡ºä¾†
        } else {
          historyDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰éå¾€ç´€éŒ„ã€‚</p>';
          console.log('âš ï¸ æ²’æœ‰ä»»ä½•æ­·å²ç´€éŒ„');
        }

      } catch (error) {
        console.error("âŒ è¼‰å…¥éå¾€ç´€éŒ„å¤±æ•—:", error);
        let historyDiv = currentRole === 'company'
          ? document.getElementById('history-records-company')
          : document.getElementById('history-records-buyer');
        if (historyDiv) {
          historyDiv.innerHTML = '<p class="error">è¼‰å…¥éå¾€ç´€éŒ„å¤±æ•—ã€‚</p>';
        }
      }
    }

    // è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¡ç‰‡
    async function loadMyCardsFirst() {
      try {
        const myCardsDiv = document.getElementById('my-cards-list-first');
        myCardsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // æ‰€æœ‰è‡ªå·±æ“æœ‰çš„å¡ç‰‡
        const userCards = await contract.getUserCards(userAccount);

        // æ‰€æœ‰ç›®å‰ä¸Šæ¶çš„äºŒæ‰‹å¡ç‰‡ UID
        const resaleCards = await contract.getResaleCards();
        const resaleUIDs = new Set(resaleCards.map(card => card[0]));

        // éæ¿¾å‡ºå°šæœªè½‰è³£çš„å¡ç‰‡
        const unsoldUserCards = userCards.filter(card => !resaleUIDs.has(card.uid));

        if (unsoldUserCards.length > 0) {
          let cardsHTML = '<table><tr><th>å¡ç‰‡UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>ç·¨è™Ÿ</th><th>åœ–ç‰‡</th><th>æ“ä½œ</th></tr>';

          for (const card of unsoldUserCards) {
            cardsHTML += `
        <tr>
          <td>${card.uid.slice(0, 10)}...${card.uid.slice(-6)}</td>
          <td>${card.idolGroup}</td>
          <td>${card.member}</td>
          <td>${card.cardNumber}</td>
          <td>${card.photoURI}</td>
          <td>
            <button onclick="viewCardDetails('${card.uid}')">æŸ¥çœ‹è©³æƒ…</button>
          </td>
        </tr>
      `;
          }

          cardsHTML += '</table>';
          myCardsDiv.innerHTML = cardsHTML;
        } else {
          myCardsDiv.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰ä»»ä½•æœªä¸Šæ¶çš„å¡ç‰‡ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¡ç‰‡å¤±æ•—:", error);
        document.getElementById('my-cards-list-first').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡å¤±æ•—ã€‚</p>';
      }
    }

    async function loadCardStats() {
      try {
        const statsDiv = document.getElementById('card-stats');
        statsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // å¾åˆç´„å–å¾—æ‰€æœ‰å…¬å¸ç™¼è¡Œçš„å¡ç‰‡
        const cards = await contract.getCompanyCards();

        if (cards && cards.length > 0) {
          let html = '<table>';
          html += '<tr><th>UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>å¡è™Ÿ</th><th>åƒ¹æ ¼ (ETH)</th><th>æ˜¯å¦å”®å‡º</th></tr>';

          for (const card of cards) {
            const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
            const priceEth = ethers.utils.formatEther(card.listPrice);
            const soldText = card.isSold ? 'âœ”ï¸ å·²å”®å‡º' : 'âŒ å°šæœªå”®å‡º';

            html += `
          <tr>
            <td title="${card.uid}">${shortUID}</td>
            <td>${card.idolGroup}</td>
            <td>${card.member}</td>
            <td>${card.cardNumber}</td>
            <td>${priceEth}</td>
            <td>${soldText}</td>
          </tr>
        `;
          }

          html += '</table>';
          statsDiv.innerHTML = html;
        } else {
          statsDiv.innerHTML = '<p>ç›®å‰å°šæœªç™¼è¡Œä»»ä½•å¡ç‰‡ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥å…¬å¸å¡ç‰‡çµ±è¨ˆå¤±æ•—:", error);
        document.getElementById('card-stats').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡è³‡è¨Šå¤±æ•—ã€‚</p>';
      }
    }


    // è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¯ç”¨äº¤æ˜“
    async function loadAvailableTradesFirst() {
      try {
        const tradesDiv = document.getElementById('available-trades-first');
        tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // ä½¿ç”¨getAvailableTradesç²å–æ‰€æœ‰å¯ç”¨äº¤æ˜“
        const trades = await contract.getAvailableTrades();

        if (trades && trades.length > 0) {
          let tradesHTML = '<table><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr>';

          for (const trade of trades) {
            tradesHTML += `
          <tr>
            <td>#${trade.tradeId}</td>
            <td>#${trade.tokenId}</td>
            <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
            <td>${ethers.utils.formatEther(trade.price)} ETH</td>
            <td>
              <button onclick="buyCard(${trade.tradeId}, '${trade.price}')">è³¼è²·</button>
            </td>
          </tr>
        `;
          }

          tradesHTML += '</table>';
          tradesDiv.innerHTML = tradesHTML;
        } else {
          tradesDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„äº¤æ˜“ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶å¯ç”¨äº¤æ˜“å¤±æ•—:", error);
        document.getElementById('available-trades-first').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
      }
    }

    //å‰µå»ºäºŒæ‰‹äº¤æ˜“
    document.getElementById("resale-btn").addEventListener("click", async () => {
      const uid = document.getElementById("card-to-sell").value.trim();
      const priceInput = document.getElementById("selling-price").value.trim();
      const statusDiv = document.getElementById("create-trade-status");

      if (!uid || !priceInput) {
        statusDiv.innerText = "è«‹é¸æ“‡å¡ç‰‡ä¸¦è¼¸å…¥åƒ¹æ ¼";
        return;
      }

      try {
        const price = ethers.utils.parseEther(priceInput);
        const tx = await contract.listCardForResale(uid, price);
        statusDiv.innerText = `äº¤æ˜“ç™¼é€ä¸­ (tx: ${tx.hash})`;
        await tx.wait();
        statusDiv.innerText = "ä¸Šæ¶æˆåŠŸï¼";
      } catch (err) {
        console.error("ä¸Šæ¶å¤±æ•—", err);
        statusDiv.innerText = `ä¸Šæ¶å¤±æ•—ï¼š${err?.reason || err?.message || "æœªçŸ¥éŒ¯èª¤"}`;
      }
    });



    // è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶çš„éŠ·å”®
    async function loadMySalesFirst() {
      try {
        const salesDiv = document.getElementById('my-sales-first');
        salesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // ä½¿ç”¨getUserTradesç²å–ç”¨æˆ¶åƒèˆ‡çš„äº¤æ˜“
        const trades = await contract.getUserTrades(userAccount);

        if (trades && trades.length > 0) {
          // éæ¿¾å‡ºç”¨æˆ¶ä½œç‚ºè³£å®¶çš„äº¤æ˜“
          const sales = trades.filter(trade => trade.seller.toLowerCase() === userAccount.toLowerCase());

          if (sales.length > 0) {
            let salesHTML = '<table><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è²·å®¶</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>';

            for (const sale of sales) {
              let statusText = '';
              let actionButton = '';

              // æ ¹æ“šäº¤æ˜“ç‹€æ…‹è¨­ç½®é¡¯ç¤ºæ–‡æœ¬å’Œæ“ä½œæŒ‰éˆ•
              switch (sale.status) {
                case 0: // Created
                  statusText = '<span class="trade-status status-created">å·²å‰µå»º</span>';
                  break;
                case 1: // BuyerSigned
                  statusText = '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
                  actionButton = `<button onclick="sellerSign(${sale.tradeId})">ç°½ç½²äº¤æ˜“</button>`;
                  break;
                case 2: // SellerSigned
                  statusText = '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
                  break;
                case 5: // Completed
                  statusText = '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
                  break;
                default:
                  statusText = `<span>ç‹€æ…‹: ${sale.status}</span>`;
              }

              salesHTML += `
            <tr>
              <td>#${sale.tradeId}</td>
              <td>#${sale.tokenId}</td>
              <td>${sale.buyer ? `${sale.buyer.slice(0, 6)}...${sale.buyer.slice(-4)}` : 'æœªå®š'}</td>
              <td>${ethers.utils.formatEther(sale.price)} ETH</td>
              <td>${statusText}</td>
              <td>${actionButton}</td>
            </tr>
          `;
            }

            salesHTML += '</table>';
            salesDiv.innerHTML = salesHTML;
          } else {
            salesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•éŠ·å”®è¨˜éŒ„ã€‚</p>';
          }
        } else {
          salesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•éŠ·å”®è¨˜éŒ„ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬ä¸€æ‰‹è²·å®¶éŠ·å”®å¤±æ•—:", error);
        document.getElementById('my-sales-first').innerHTML = '<p class="error">è¼‰å…¥éŠ·å”®è¨˜éŒ„å¤±æ•—ã€‚</p>';
      }
    }

    // è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶å¡ç‰‡
    async function loadMyCardsSecond() {
      try {
        const myCardsDiv = document.getElementById('my-cards-list-second');
        const cardToSell = document.getElementById('card-to-sell');

        myCardsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // æ¸…ç©ºä¸‹æ‹‰é¸å–®
        while (cardToSell.options.length > 1) {
          cardToSell.remove(1);
        }

        // å–å¾—è‡ªå·±æ“æœ‰çš„å¡ç‰‡
        const userCards = await contract.getUserCards(userAccount);

        // å–å¾—æ‰€æœ‰ä¸Šæ¶å¡ç‰‡ UIDï¼ˆresaleCards æ˜¯ array of arrayï¼‰
        const resaleCards = await contract.getResaleCards();
        const resaleUIDs = new Set(resaleCards.map(card => card[0]));

        // åˆ†æˆå…©é¡
        const listedCards = userCards.filter(card => resaleUIDs.has(card.uid));     // å·²ä¸Šæ¶
        const unlistedCards = userCards.filter(card => !resaleUIDs.has(card.uid));  // æœªä¸Šæ¶

        // é¡¯ç¤ºã€Œå·²ä¸Šæ¶ã€å¡ç‰‡åœ¨è¡¨æ ¼ä¸­
        if (listedCards.length > 0) {
          let cardsHTML = '<table><tr><th>å¡ç‰‡UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>ç·¨è™Ÿ</th><th>åœ–ç‰‡</th><th>æ“ä½œ</th></tr>';

          for (const card of listedCards) {
            cardsHTML += `
        <tr>
          <td>${card.uid.slice(0, 10)}...${card.uid.slice(-6)}</td>
          <td>${card.idolGroup}</td>
          <td>${card.member}</td>
          <td>${card.cardNumber}</td>
          <td>${card.photoURI}</td>
          <td><button onclick="viewCardDetails('${card.uid}')">æŸ¥çœ‹è©³æƒ…1</button></td>
        </tr>
        `;
          }

          cardsHTML += '</table>';
          myCardsDiv.innerHTML = cardsHTML;
        } else {
          myCardsDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰æ‚¨ä¸Šæ¶ä¸­çš„å¡ç‰‡ã€‚</p>';
        }

        // å°‡ã€Œæœªä¸Šæ¶ã€å¡ç‰‡åŠ åˆ°ä¸‹æ‹‰é¸å–®
        for (const card of unlistedCards) {
          const option = document.createElement('option');
          option.value = card.uid;
          option.textContent = `${card.idolGroup} - ${card.member} (${card.cardNumber})`;
          cardToSell.appendChild(option);
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è³£å®¶å¡ç‰‡å¤±æ•—:", error);
        document.getElementById('my-cards-list-second').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡å¤±æ•—ã€‚</p>';
      }
    }


    // è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶å¯ç”¨äº¤æ˜“
    async function loadAvailableTradesSecond() {
      // èˆ‡loadAvailableTradesFirståŸºæœ¬ç›¸åŒ
      try {
        const tradesDiv = document.getElementById('available-trades-second');
        tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        const trades = await contract.getAvailableTrades();

        if (trades && trades.length > 0) {
          let tradesHTML = '<table><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr>';

          for (const trade of trades) {
            tradesHTML += `
          <tr>
            <td>#${trade.tradeId}</td>
            <td>#${trade.tokenId}</td>
            <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
            <td>${ethers.utils.formatEther(trade.price)} ETH</td>
            <td>
              <button onclick="buyCard(${trade.tradeId}, '${trade.price}')">è³¼è²·</button>
            </td>
          </tr>
        `;
          }

          tradesHTML += '</table>';
          tradesDiv.innerHTML = tradesHTML;
        } else {
          tradesDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„äº¤æ˜“ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶å¯ç”¨äº¤æ˜“å¤±æ•—:", error);
        document.getElementById('available-trades-second').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
      }
    }

    async function sellerSign(tradeId) {
      try {
        await contract.sellerSign(tradeId);
        alert('è³£å®¶ç°½ç½²æˆåŠŸï¼');
        loadMyTradesSecond();
      } catch (error) {
        console.error("ç°½ç½²å¤±æ•—:", error);
        alert('ç°½ç½²å¤±æ•—ï¼š' + error.message);
      }
    }

    async function finalize(tradeId) {
      try {
        await contract.finalize(tradeId);
        alert('äº¤æ˜“å®Œæˆï¼');
        loadMyTradesSecond();
      } catch (error) {
        console.error("å®Œæˆäº¤æ˜“å¤±æ•—:", error);
        alert('å®Œæˆäº¤æ˜“å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶çš„äº¤æ˜“ç®¡ç†
    async function loadMyTradesSecond() {
      try {
        const tradesDiv = document.getElementById('my-trades-second');
        tradesDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // ä½¿ç”¨getUserTradesç²å–ç”¨æˆ¶åƒèˆ‡çš„äº¤æ˜“
        const trades = await contract.getUserTrades(userAccount);

        if (trades && trades.length > 0) {
          let tradesHTML = '<table><tr><th>äº¤æ˜“ID</th><th>å¡ç‰‡ID</th><th>è§’è‰²</th><th>äº¤æ˜“å°è±¡</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>';

          for (const trade of trades) {
            let roleText = '';
            let counterparty = '';
            let actionButton = '';
            let statusText = '';

            // ç¢ºå®šç”¨æˆ¶è§’è‰²
            if (trade.seller.toLowerCase() === userAccount.toLowerCase()) {
              roleText = 'è³£å®¶';
              counterparty = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'æœªå®š';

              // æ ¹æ“šäº¤æ˜“ç‹€æ…‹è¨­ç½®æ“ä½œæŒ‰éˆ•
              if (trade.status === 1) { // BuyerSigned
                actionButton = `<button onclick="sellerSign(${trade.tradeId})">ç°½ç½²äº¤æ˜“</button>`;
              }
            } else {
              roleText = 'è²·å®¶';
              counterparty = `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}`;

              // æ ¹æ“šäº¤æ˜“ç‹€æ…‹è¨­ç½®æ“ä½œæŒ‰éˆ•
              if (trade.status === 2) { // SellerSigned
                actionButton = `<button onclick="finalize(${trade.tradeId})">å®Œæˆäº¤æ˜“</button>`;
              }
            }

            // è¨­ç½®ç‹€æ…‹æ–‡æœ¬
            switch (trade.status) {
              case 0: // Created
                statusText = '<span class="trade-status status-created">å·²å‰µå»º</span>';
                break;
              case 1: // BuyerSigned
                statusText = '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
                break;
              case 2: // SellerSigned
                statusText = '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
                break;
              case 5: // Completed
                statusText = '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
                break;
              default:
                statusText = `<span>ç‹€æ…‹: ${trade.status}</span>`;
            }

            tradesHTML += `
          <tr>
            <td>#${trade.tradeId}</td>
            <td>#${trade.tokenId}</td>
            <td>${roleText}</td>
            <td>${counterparty}</td>
            <td>${ethers.utils.formatEther(trade.price)} ETH</td>
            <td>${statusText}</td>
            <td>${actionButton}</td>
          </tr>
        `;
          }

          tradesHTML += '</table>';
          tradesDiv.innerHTML = tradesHTML;
        } else {
          tradesDiv.innerHTML = '<p>æ‚¨æ²’æœ‰ä»»ä½•äº¤æ˜“è¨˜éŒ„ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥ç¬¬äºŒæ‰‹è²·å®¶/è³£å®¶äº¤æ˜“ç®¡ç†å¤±æ•—:", error);
        document.getElementById('my-trades-second').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“ç®¡ç†å¤±æ•—ã€‚</p>';
      }
    }

    // è¼‰å…¥æ‰€æœ‰äº¤æ˜“æ¦‚è¦½
    // async function loadAllTradesOverview() {
    //   if (!isOwner) {
    //     document.getElementById('all-trades-overview').innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯æŸ¥çœ‹äº¤æ˜“æ¦‚è¦½ã€‚</p>';
    //     console.log('[loadAllTradesOverview] éæ“æœ‰è€…ï¼Œç„¡æ³•æŸ¥çœ‹äº¤æ˜“æ¦‚è¦½');
    //     return;
    //   }
    //   try {
    //     const overviewDiv = document.getElementById('all-trades-overview');
    //     overviewDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

    //     // ä½¿ç”¨åˆç´„å‡½æ•¸å–å¾—äº¤æ˜“çµ±è¨ˆæ•¸æ“š
    //     const analytics = await contract.getTradeAnalytics();
    //     const totalTrades = analytics.totalTrades.toNumber();

    //     if (totalTrades === 0) {
    //       overviewDiv.innerHTML = '<p>ç›®å‰å°šç„¡äº¤æ˜“ç´€éŒ„ã€‚</p>';
    //       return;
    //     }

    //     const trades = [];
    //     for (let i = 1; i <= totalTrades; i++) {
    //       try {
    //         const trade = await contract.getTrade(i);
    //         console.log(`[loadAllTradesOverview] å–å¾—äº¤æ˜“ #${i}:`, trade);

    //         trades.push({
    //           tradeId: i,
    //           tokenId: trade.tokenId,
    //           seller: trade.seller,
    //           buyer: trade.buyer,
    //           price: trade.price,
    //           status: trade.status,
    //           deadline: trade.deadline
    //         });
    //       } catch (err) {
    //         console.warn(`[loadAllTradesOverview] è·³éäº¤æ˜“ #${i}ï¼ˆå¯èƒ½å·²åˆªé™¤ï¼‰`, err);
    //       }
    //     }

    //     // å»ºç«‹ HTML è¡¨æ ¼
    //     let html = '<table>';
    //     html += `
    //       <tr>
    //         <th>äº¤æ˜“ID</th>
    //         <th>å¡ç‰‡ID</th>
    //         <th>è³£å®¶</th>
    //         <th>è²·å®¶</th>
    //         <th>åƒ¹æ ¼ (ETH)</th>
    //         <th>ç‹€æ…‹</th>
    //       </tr>
    //     `;

    //     for (const trade of trades) {
    //       const priceEth = ethers.utils.formatEther(trade.price);
    //       const sellerShort = `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}`;
    //       const buyerShort = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'â€”';

    //       let statusText = '';
    //       switch (trade.status) {
    //         case 0: statusText = '<span class="trade-status status-created">å·²å‰µå»º</span>'; break;
    //         case 1: statusText = '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>'; break;
    //         case 2: statusText = '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>'; break;
    //         case 5: statusText = '<span class="trade-status status-completed">å·²å®Œæˆ</span>'; break;
    //         default: statusText = `<span class="trade-status">æœªçŸ¥ç‹€æ…‹ï¼ˆ${trade.status}ï¼‰</span>`;
    //       }

    //       html += `
    //         <tr>
    //           <td>#${trade.tradeId}</td>
    //           <td>#${trade.tokenId}</td>
    //           <td>${sellerShort}</td>
    //           <td>${buyerShort}</td>
    //           <td>${priceEth}</td>
    //           <td>${statusText}</td>
    //         </tr>
    //       `;
    //     }

    //     html += '</table>';
    //     overviewDiv.innerHTML = html;

    //   } catch (error) {
    //     console.error("è¼‰å…¥äº¤æ˜“æ¦‚è¦½å¤±æ•—:", error);
    //     document.getElementById('all-trades-overview').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
    //   }
    // }

    async function loadAllTradesOverview() {
      const overviewDiv = document.getElementById('all-trades-overview');
      if (!contract) {
        overviewDiv.innerHTML = '<p>å°šæœªé€£æ¥åˆç´„ã€‚</p>';
        return;
      }
      if (!isOwner) {
        overviewDiv.innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯æŸ¥çœ‹äº¤æ˜“æ¦‚è¦½ã€‚</p>';
        return;
      }

      try {
        overviewDiv.innerHTML = '<p>å·²é€£æ¥åˆç´„å¾…åˆä½µç¨‹å¼</p>';

        // ä½ åŸæœ¬å…¶ä»–é‚è¼¯å¾ŒçºŒå¯æ”¾é€™è£¡
      } catch (error) {
        console.error("è¼‰å…¥äº¤æ˜“æ¦‚è¦½å¤±æ•—:", error);
        overviewDiv.innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
      }
    }



    // è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æ
    // async function loadTradeAnalytics() {
    //   if (!isOwner) {
    //     document.getElementById('trade-analytics').innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥æŸ¥çœ‹äº¤æ˜“æ•¸æ“šåˆ†æã€‚</p>';
    //     return;
    //   }
    //   try {
    //     const analyticsDiv = document.getElementById('trade-analytics');
    //     analyticsDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

    //     const analytics = await contract.getTradeAnalytics();
    //     console.log('[loadTradeAnalytics] getTradeAnalytics å›å‚³:', analytics);

    //     // è‹¥å›å‚³ç‰©ä»¶ä¸­æ˜¯ BigNumberï¼Œè¦ç¢ºèªæ ¼å¼
    //     console.log('[loadTradeAnalytics] å„æ¬„ä½å‹æ…‹èˆ‡å€¼:', {
    //       totalTrades: analytics.totalTrades,
    //       completedTrades: analytics.completedTrades,
    //       pendingTrades: analytics.pendingTrades,
    //       totalVolume: analytics.totalVolume
    //     });

    //     let analyticsHTML = `
    //       <div>
    //         <h3>äº¤æ˜“çµ±è¨ˆ</h3>
    //         <p>ç¸½äº¤æ˜“æ•¸: ${analytics.totalTrades}</p>
    //         <p>å·²å®Œæˆäº¤æ˜“: ${analytics.completedTrades}</p>
    //         <p>å¾…è™•ç†äº¤æ˜“: ${analytics.pendingTrades}</p>
    //         <p>ç¸½äº¤æ˜“é‡: ${ethers.utils.formatEther(analytics.totalVolume)} ETH</p>
    //       </div>
    //     `;

    //     // TODO: æ·»åŠ æ›´å¤šåˆ†æï¼Œå¦‚æ¯æ—¥/æ¯é€±äº¤æ˜“é‡ï¼Œå¹³å‡åƒ¹æ ¼ç­‰

    //     analyticsDiv.innerHTML = analyticsHTML;
    //   } catch (error) {
    //     console.error("è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—:", error);
    //     document.getElementById('trade-analytics').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—ã€‚</p>';
    //   }
    // }

    async function loadTradeAnalytics() {
      const analyticsDiv = document.getElementById('trade-analytics');
      if (!contract) {
        analyticsDiv.innerHTML = '<p>å°šæœªé€£æ¥åˆç´„ã€‚</p>';
        return;
      }
      if (!isOwner) {
        analyticsDiv.innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥æŸ¥çœ‹äº¤æ˜“æ•¸æ“šåˆ†æã€‚</p>';
        return;
      }
      try {
        analyticsDiv.innerHTML = '<p>å·²é€£æ¥åˆç´„å¾…åˆä½µç¨‹å¼</p>';

        // ä½ åŸæœ¬å…¶ä»–é‚è¼¯å¾ŒçºŒå¯æ”¾é€™è£¡
      } catch (error) {
        console.error("è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—:", error);
        analyticsDiv.innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“æ•¸æ“šåˆ†æå¤±æ•—ã€‚</p>';
      }
    }


    async function loadAvailableCardsMarket() {
      const marketDiv = document.getElementById('available-cards-market');

      try {
        marketDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // ä¸»åˆç´„ç²å–æ‰€æœ‰å¯è³¼è²·å¡ç‰‡
        const availableCards = await contract.getAvailableCards();
        console.log("å¯ç”¨å¡ç‰‡:", availableCards);

        if (availableCards && availableCards.length > 0) {
          let cardsHTML = '<table><tr><th>å¡ç‰‡UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>ç·¨è™Ÿ</th><th>åƒ¹æ ¼</th><th>åœ–ç‰‡</th><th>æ“ä½œ</th></tr>';

          for (const card of availableCards) {
            if (card.isSold) continue;
            // é¡¯ç¤ºUIDçš„å‰10ä½å’Œå¾Œ6ä½
            const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
            // æ ¼å¼åŒ–åƒ¹æ ¼é¡¯ç¤º
            const priceEth = ethers.utils.formatEther(card.listPrice);
            // ä½¿ç”¨åŸå§‹åƒ¹æ ¼å€¼ä½œç‚ºåƒæ•¸å‚³é
            const priceWei = card.listPrice.toString();

            cardsHTML += `
              <tr>
                <td title="${card.uid}">${shortUID}</td>
                <td>${card.idolGroup}</td>
                <td>${card.member}</td>
                <td>${card.cardNumber}</td>
                <td>${priceEth} ETH</td>
                <td>
                  <button onclick="purchaseSpecificCard('${card.uid}', '${priceWei}')">è³¼è²·</button>
                </td>
              </tr>
            `;
          }

          cardsHTML += '</table>';
          marketDiv.innerHTML = cardsHTML;
        } else {
          marketDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯è³¼è²·çš„å¡ç‰‡ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥å¸‚å ´å¡ç‰‡å¤±æ•—:", error);
        marketDiv.innerHTML = `<p class="error">è¼‰å…¥å¸‚å ´å¡ç‰‡å¤±æ•—: ${error.message}</p>`;
      }
    }

    // å°‡æ“ä½œå‡½æ•¸æ›åˆ°windowå°è±¡ä¸Š
    window.purchaseSpecificCard = purchaseSpecificCard;
    window.approveTransfer = approveTransfer;
    window.buyCard = buyCard;
    window.sellerSign = sellerSign;
    window.finalize = finalize;

    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
      if (!contract) return;

      // ç›£è½å¡ç‰‡è³¼è²·äº‹ä»¶
      contract.on("CardPurchased", (buyer, amount, uid) => {
        console.log("æ•ç²åˆ° CardPurchased äº‹ä»¶:", buyer, amount.toString(), uid);

        if (buyer.toLowerCase() === userAccount.toLowerCase()) {
          console.log("ç”¨æˆ¶è³¼è²·å¡ç‰‡ï¼ŒUID:", uid);
          // æ›´æ–°UIé¡¯ç¤º
          const purchaseStatus = document.getElementById('purchase-status');
          if (purchaseStatus) {
            purchaseStatus.innerHTML = `
          <div class="status success">
            <p>è³¼è²·æˆåŠŸï¼</p>
            <p>è«‹ä½¿ç”¨æƒæå™¨æƒææ‚¨çš„å¡ç‰‡ UIDï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ã€‚</p>
            <p>æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä¾†ç”³è«‹å¡ç‰‡æ‰€æœ‰æ¬Šè½‰ç§»ã€‚</p>
          </div>
        `;
          }

          // è‡ªå‹•å¡«å…¥ UID åˆ°ç¶å®šè¼¸å…¥æ¡†
          const uidInput = document.getElementById('card-uid');
          if (uidInput) uidInput.value = uid;
          loadAvailableCardsMarket();

        }
      });

    }
    async function loadResaleCardsMarket() {
      const resaleDiv = document.getElementById('resale-cards-market');

      try {
        resaleDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // å–å¾—ç›®å‰ç”¨æˆ¶æ“æœ‰çš„å¡ç‰‡ UIDï¼ˆé˜²æ­¢è²·åˆ°è‡ªå·±å¡ç‰‡ï¼‰
        const userCards = await contract.getUserCards(userAccount);
        for (const card of userCards) {
          console.log(card.uid);         
          console.log(card.idolGroup);  
          console.log(card.member);     
          console.log(card.cardNumber); 
          console.log(card.listPrice);
          console.log(card.photoURI);
        }
        const ownedUIDs = new Set(userCards.map(card => card.uid));

        // å‘¼å«åˆç´„ä¸­çš„ getResaleCards()
        const resaleCards = await contract.getResaleCards();
        console.log("äºŒæ‰‹å¡ç‰‡:", resaleCards);

        // éæ¿¾æ‰ç”¨æˆ¶è‡ªå·±æ“æœ‰çš„å¡ç‰‡ï¼ˆä¸èƒ½è²·è‡ªå·±çš„å¡ï¼‰
        const filteredResaleCards = resaleCards.filter(card => {
          const cardUid = card[0];
          return !ownedUIDs.has(cardUid);
        });

        if (filteredResaleCards.length > 0) {
          let cardsHTML = '<table><tr><th>å¡ç‰‡UID</th><th>åœ˜é«”</th><th>æˆå“¡</th><th>ç·¨è™Ÿ</th><th>åƒ¹æ ¼</th><th>åœ–ç‰‡</th><th>æ“ä½œ</th></tr>';
          
          console.log("å¡ç‰‡æ¬„ä½",filteredResaleCards)
          for (const card of filteredResaleCards) {
            const uid = card.uid;
            const idolGroup = card.idolGroup;
            const member = card.member;
            const cardNumber = card.cardNumber;
            const listPrice = card[4];
            const photoURI = card.photoURI;
            const isSold = card[6];

            const priceEth = ethers.utils.formatEther(listPrice.toString());
            const shortUID = `${uid.slice(0, 10)}...${uid.slice(-6)}`;

            cardsHTML += `
          <tr>
            <td title="${uid}">${shortUID}</td>
            <td>${idolGroup}</td>
            <td>${member}</td>
            <td>${cardNumber}</td>
            <td>${priceEth} ETH</td>
            <td>${photoURI}</td>
            <td><button onclick="buyResaleCard('${uid}', '${listPrice}')">è³¼è²·</button></td>
          </tr>
        `;
          }

          cardsHTML += '</table>';
          resaleDiv.innerHTML = cardsHTML;
        } else {
          resaleDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰è½‰å”®çš„å¡ç‰‡ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥äºŒæ‰‹å¸‚å ´å¡ç‰‡å¤±æ•—:", error);
        resaleDiv.innerHTML = `<p class="error">è¼‰å…¥äºŒæ‰‹å¸‚å ´å¡ç‰‡å¤±æ•—: ${error.message}</p>`;
      }
    }


    // æ·»åŠ åˆ°æ‚¨çš„ JS æ–‡ä»¶ä¸­
    async function testContractFunctions() {
      console.log("é–‹å§‹æ¸¬è©¦åˆç´„åŠŸèƒ½...");

      try {
        // 1. æª¢æŸ¥åˆç´„æ˜¯å¦å·²é€£æ¥
        console.log("åˆç´„å¯¦ä¾‹:", contract);

        // 2. æª¢æŸ¥åˆç´„ ABI ä¸­æ˜¯å¦æœ‰æ­£ç¢ºçš„å‡½æ•¸å®šç¾©
        console.log("åˆç´„ ABI:", contractABI);

        // 3. å˜—è©¦ç²å–å¯ç”¨å¡ç‰‡
        console.log("å˜—è©¦ç²å–å¯ç”¨å¡ç‰‡...");
        const cards = await contract.getAvailableCards();
        console.log("å¯ç”¨å¡ç‰‡:", cards);

        // 4. å˜—è©¦æª¢æŸ¥äº‹ä»¶å®šç¾©
        console.log("æª¢æŸ¥äº‹ä»¶å®šç¾©...");
        const filter = contract.filters.CardPurchased();
        console.log("CardPurchased äº‹ä»¶éæ¿¾å™¨:", filter);

        // 5. æª¢æŸ¥éŒ¢åŒ…é¤˜é¡
        const balance = await window.ethereum.request({
          method: 'eth_getBalance',
          params: [userAccount, 'latest']
        });
        console.log("éŒ¢åŒ…é¤˜é¡:", ethers.utils.formatEther(balance), "ETH");

        console.log("æ¸¬è©¦å®Œæˆ");
      } catch (error) {
        console.error("åˆç´„åŠŸèƒ½æ¸¬è©¦å¤±æ•—:", error);
      }
    }

    // å°‡å…¶æ·»åŠ åˆ° window å°è±¡
    window.testContractFunctions = testContractFunctions;


    // æ·»åŠ è³¼è²·ç‰¹å®šå¡ç‰‡çš„å‡½æ•¸
    async function purchaseSpecificCard(uid, priceWei) {
      const purchaseStatus = document.getElementById('purchase-status');
      try {
        purchaseStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
        purchaseStatus.className = 'status info';

        console.log("æº–å‚™è³¼è²·å¡ç‰‡:", uid);
        console.log("åƒ¹æ ¼(Wei):", priceWei);

        // è½‰æˆ BigNumberï¼Œé¿å…æ ¼å¼éŒ¯èª¤
        let valueForTx;
        try {
          valueForTx = ethers.BigNumber.from(priceWei);
        } catch (e) {
          purchaseStatus.innerHTML = `<div class="status error">åƒ¹æ ¼æ ¼å¼éŒ¯èª¤: ${e.message}</div>`;
          purchaseStatus.className = 'status error';
          return;
        }

        // å¾é é¢å–å¾—å·²é€£æ¥éŒ¢åŒ…åœ°å€ (å‡è¨­ connectionStatus æ˜¯è©²å…ƒç´ ID)
        const connectionStatus = document.getElementById('connection-status');
        if (!connectionStatus || !connectionStatus.textContent) {
          purchaseStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
          purchaseStatus.className = 'status error';
          return;
        }
        // å‡è¨­ textContent æ ¼å¼æ˜¯ 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š0x1234...abcd'
        // åªå–åœ°å€éƒ¨åˆ†ï¼Œå»æ‰å‰ç¶´
        const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
        let signerAddress = connectionStatus.textContent.trim();
        if (signerAddress.startsWith(prefix)) {
          signerAddress = signerAddress.slice(prefix.length).trim();
        }

        // ç°¡å–®é©—è­‰åœ°å€æ ¼å¼ï¼ˆå¯æ”¹ç”¨ ethers.utils.isAddressï¼‰
        if (!ethers.utils.isAddress(signerAddress)) {
          purchaseStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
          purchaseStatus.className = 'status error';
          return;
        }

        console.log("æ¥æ”¶è€…éŒ¢åŒ…åœ°å€:", signerAddress);
        console.log("å‚³å…¥ UID:", uid);
        // callStatic æ¨¡æ“¬äº¤æ˜“ï¼Œå¸¶ uid èˆ‡ recipient
        try {
          const returnedUidCheck = await contract.callStatic.purchaseSpecificCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: 500000,
          });
          console.log("æ¨¡æ“¬æˆåŠŸï¼Œè¿”å›UID:", returnedUidCheck);
        } catch (staticError) {
          console.warn("æ¨¡æ“¬å¤±æ•—ï¼Œå¯èƒ½äº¤æ˜“æœƒ revert:", staticError);
          // ä¾éœ€æ±‚æ±ºå®šæ˜¯å¦return
          // return;
        }

        // ç™¼é€äº¤æ˜“ï¼Œå¸¶ uid èˆ‡ recipient
        const tx = await contract.purchaseSpecificCard(uid, signerAddress, {
          value: valueForTx,
          gasLimit: 500000,
        });
        console.log("äº¤æ˜“ç™¼é€:", tx);

        const receipt = await tx.wait();
        console.log("äº¤æ˜“ç¢ºèª:", receipt);

        // ğŸ”¥ åŠ ä¸Šé€™æ®µï¼šæŸ¥è©¢ tokenId ä¸¦è¨˜éŒ„äº¤æ˜“
        try {
          const tokenId = await contract.uidToTokenId(uid);
          console.log("å°æ‡‰ tokenId:", tokenId.toString());

          const tx2 = await contract.recordPrimaryTrade(uid, tokenId, signerAddress, valueForTx);
          await tx2.wait();
          console.log("âœ… ä¸€æ‰‹äº¤æ˜“å·²è¨˜éŒ„åˆ° TradeManager");
        } catch (e) {
          console.warn("âš ï¸ ç„¡æ³•è¨˜éŒ„ä¸€æ‰‹äº¤æ˜“:", e.message);
        }

        purchaseStatus.innerHTML = `
          <div class="status success">
            <p>è³¼è²·æˆåŠŸï¼</p>
            <p>è«‹æƒææˆ–è¼¸å…¥å¡ç‰‡ UID</p>
            <p>ä¸¦æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä»¥ç¶ä¸Šã€‚</p>
          </div>
        `;

        // è‡ªå‹•å¡«å…¥ç¶å®šæ¬„ä½
        const cardUidInput = document.getElementById('card-uid');
        if (cardUidInput) {
          cardUidInput.value = uid;
        }

        // é‡æ–°è¼‰å…¥å¸‚å ´å¡ç‰‡
        await loadAvailableCardsMarket();

      } catch (error) {
        console.error("è³¼è²·å¡ç‰‡å¤±æ•—:", error);
        let errorMessage = error.message || "æœªçŸ¥éŒ¯èª¤";

        if (error.code === 'ACTION_REJECTED') {
          errorMessage = "äº¤æ˜“è¢«ç”¨æˆ¶æ‹’çµ•";
        } else if (error.code === 'CALL_EXCEPTION') {
          errorMessage = "åˆç´„åŸ·è¡ŒéŒ¯èª¤ï¼Œè«‹ç¢ºèªéŒ¢åŒ…é¤˜é¡æˆ–å¡ç‰‡ç‹€æ…‹";
        }

        purchaseStatus.innerHTML = `<div class="status error">è³¼è²·å¡ç‰‡å¤±æ•—: ${errorMessage}</div>`;
        purchaseStatus.className = 'status error';
      }
    }
    document.getElementById('card-modal-close').addEventListener('click', () => {
      const modal = document.getElementById('card-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    });

    async function buyResaleCard(uid, priceWei) {
      const purchaseStatus = document.getElementById('purchase-status');
      try {
        purchaseStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
        purchaseStatus.className = 'status info';

        console.log("æº–å‚™è³¼è²·äºŒæ‰‹å¡ç‰‡:", uid);
        console.log("åƒ¹æ ¼(Wei):", priceWei);

        // è½‰æ›åƒ¹æ ¼ç‚º BigNumber ä»¥é¿å…æ ¼å¼éŒ¯èª¤
        let valueForTx;
        try {
          valueForTx = ethers.BigNumber.from(priceWei);
        } catch (e) {
          purchaseStatus.innerHTML = `<div class="status error">åƒ¹æ ¼æ ¼å¼éŒ¯èª¤: ${e.message}</div>`;
          purchaseStatus.className = 'status error';
          return;
        }

        // å–å¾—é€£æ¥éŒ¢åŒ…åœ°å€
        const connectionStatus = document.getElementById('connection-status');
        if (!connectionStatus || !connectionStatus.textContent) {
          purchaseStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
          purchaseStatus.className = 'status error';
          return;
        }

        let signerAddress = connectionStatus.textContent.trim();
        const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
        if (signerAddress.startsWith(prefix)) {
          signerAddress = signerAddress.slice(prefix.length).trim();
        }

        // ç°¡å–®çš„åœ°å€é©—è­‰
        if (!ethers.utils.isAddress(signerAddress)) {
          purchaseStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
          purchaseStatus.className = 'status error';
          return;
        }

        console.log("æ¥æ”¶è€…éŒ¢åŒ…åœ°å€:", signerAddress);
        console.log("å‚³å…¥ UID:", uid);
        
        const tokenId = await contract.uidToTokenId(uid);
        console.log("å°æ‡‰ tokenId:", tokenId.toString());

        const seller = await contract.getNFTHolder(uid);
        console.log("è³£å®¶åœ°å€:", seller);

        // æ¨¡æ“¬äº¤æ˜“ï¼Œæª¢æŸ¥æ˜¯å¦å¯ç”¨
        try {
          const returnedUidCheck = await contract.callStatic.purchaseResaleCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: 500000,
          });
          console.log("æ¨¡æ“¬æˆåŠŸï¼Œè¿”å›UID:", returnedUidCheck);
        } catch (staticError) {
          console.warn("æ¨¡æ“¬å¤±æ•—ï¼Œå¯èƒ½äº¤æ˜“æœƒ revert:", staticError);
        }

        // ç™¼é€äº¤æ˜“ï¼Œå¸¶ä¸Š uid å’Œ recipient
        const tx = await contract.purchaseResaleCard(uid, signerAddress, {
          value: valueForTx,
          gasLimit: 500000,
        });
        console.log("äº¤æ˜“ç™¼é€:", tx);

        const receipt = await tx.wait();
        console.log("äº¤æ˜“ç¢ºèª:", receipt);

        // äº¤æ˜“å®Œæˆå¾Œï¼Œè¨˜éŒ„äºŒæ‰‹äº¤æ˜“
        try {
          // è¨˜éŒ„äºŒæ‰‹äº¤æ˜“
          const tx2 = await contract.recordSecondaryTrade(uid, tokenId, seller, receipt.from, valueForTx);
          await tx2.wait();
          console.log("âœ… äºŒæ‰‹äº¤æ˜“å·²è¨˜éŒ„åˆ° TradeManager");
        } catch (e) {
          console.warn("âš ï¸ ç„¡æ³•è¨˜éŒ„äºŒæ‰‹äº¤æ˜“:", e.message);
        }

        purchaseStatus.innerHTML = `
        <div class="status success">
            <p>è³¼è²·æˆåŠŸï¼</p>
            <p>è«‹æƒææˆ–è¼¸å…¥å¡ç‰‡ UID</p>
            <p>ä¸¦æŒ‰ä¸‹ã€Œç¶å®šå¡ç‰‡ã€æŒ‰éˆ•ä»¥ç¶ä¸Šã€‚</p>
        </div>
        `;

        // è‡ªå‹•å¡«å…¥ç¶å®šæ¬„ä½
        const cardUidInput = document.getElementById('card-uid');
        if (cardUidInput) {
          cardUidInput.value = uid;
        }

        // é‡æ–°è¼‰å…¥å¸‚å ´å¡ç‰‡
        await loadResaleCardsMarket();

      } catch (error) {
        console.error("è³¼è²·äºŒæ‰‹å¡ç‰‡å¤±æ•—:", error);
        let errorMessage = error.message || "æœªçŸ¥éŒ¯èª¤";

        if (error.code === 'ACTION_REJECTED') {
          errorMessage = "äº¤æ˜“è¢«ç”¨æˆ¶æ‹’çµ•";
        } else if (error.code === 'CALL_EXCEPTION') {
          errorMessage = "åˆç´„åŸ·è¡ŒéŒ¯èª¤ï¼Œè«‹ç¢ºèªéŒ¢åŒ…é¤˜é¡æˆ–å¡ç‰‡ç‹€æ…‹";
        }

        purchaseStatus.innerHTML = `<div class="status error">è³¼è²·äºŒæ‰‹å¡ç‰‡å¤±æ•—: ${errorMessage}</div>`;
        purchaseStatus.className = 'status error';
      }
    }
    window.buyResaleCard = buyResaleCard;


    // è¼‰å…¥æˆ‘çš„å¡ç‰‡
    async function loadMyCards() {
      try {
        const balance = await contract.balanceOf(userAccount);
        const myCardsList = document.getElementById('my-cards-list');
        const cardToSell = document.getElementById('card-to-sell');

        // æ¸…ç©ºä¸‹æ‹‰é¸å–®
        while (cardToSell.options.length > 1) {
          cardToSell.remove(1);
        }

        if (balance > 0) {
          let cardsHTML = '<table><tr><th>Token ID</th><th>æ“ä½œ</th></tr>';

          for (let i = 0; i < balance; i++) {
            const tokenId = await contract.tokenOfOwnerByIndex(userAccount, i);

            cardsHTML += `
              <tr>
                <td>å¡ç‰‡ #${tokenId}</td>
                <td>
                  <button onclick="viewCardDetails(${tokenId})">æŸ¥çœ‹è©³æƒ…</button>
                </td>
              </tr>
            `;

            // æ·»åŠ åˆ°ä¸‹æ‹‰é¸å–®
            const option = document.createElement('option');
            option.value = tokenId;
            option.textContent = `å¡ç‰‡ #${tokenId}`;
            cardToSell.appendChild(option);
          }

          cardsHTML += '</table>';
          myCardsList.innerHTML = cardsHTML;
        } else {
          myCardsList.innerHTML = '<p>æ‚¨é‚„æ²’æœ‰ä»»ä½•å¡ç‰‡ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥å¡ç‰‡å¤±æ•—:", error);
        document.getElementById('my-cards-list').innerHTML = '<p class="error">è¼‰å…¥å¡ç‰‡å¤±æ•—ã€‚</p>';
      }
    }

    // è¼‰å…¥å¯ç”¨äº¤æ˜“
    async function loadAvailableTrades() {
      try {
        const trades = await contract.getAvailableTrades();
        const availableTradesDiv = document.getElementById('available-trades');

        if (trades.length > 0) {
          let tradesHTML = '<table><tr><th>äº¤æ˜“ ID</th><th>å¡ç‰‡ ID</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr>';

          for (const trade of trades) {
            tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>å¡ç‰‡ #${trade.tokenId}</td>
                <td>${ethers.utils.formatEther(trade.price)
              } ETH</td>
                <td>
                  <button onclick="buyCard(${trade.tradeId}, '${trade.price}')">è³¼è²·</button>
                </td>
              </tr>
            `;
          }

          tradesHTML += '</table>';
          availableTradesDiv.innerHTML = tradesHTML;
        } else {
          availableTradesDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„äº¤æ˜“ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥äº¤æ˜“å¤±æ•—:", error);
        document.getElementById('available-trades').innerHTML = '<p class="error">è¼‰å…¥äº¤æ˜“å¤±æ•—ã€‚</p>';
      }
    }

    // è¼‰å…¥æˆ‘çš„äº¤æ˜“
    async function loadMyTrades() {
      // é€™éƒ¨åˆ†éœ€è¦é¡å¤–å¯¦ç¾ç²å–ç”¨æˆ¶ç›¸é—œäº¤æ˜“çš„æ–¹æ³•
      // åˆç´„ä¸­æ²’æœ‰ç›´æ¥æä¾›ç²å–ç”¨æˆ¶äº¤æ˜“çš„å‡½æ•¸ï¼Œéœ€è¦å‰ç«¯è¨˜éŒ„æˆ–ä¿®æ”¹åˆç´„
      document.getElementById('my-trades').innerHTML = '<p>åŠŸèƒ½é–‹ç™¼ä¸­...</p>';
    }

    // è¼‰å…¥å¾…è™•ç†çš„è«‹æ±‚ (åƒ…ç®¡ç†å“¡)
    async function loadPendingRequests() {
      if (!isOwner) {
        document.getElementById('pending-requests').innerHTML = '<p>åªæœ‰åˆç´„æ“æœ‰è€…å¯æŸ¥çœ‹å¾…è™•ç†è«‹æ±‚ã€‚</p>';
        return;
      }

      try {
        const pendingDiv = document.getElementById('pending-requests');
        pendingDiv.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

        // ç²å–å¾…è™•ç†è«‹æ±‚
        const pendingRequests = await contract.getPendingCardRequests();

        if (pendingRequests && pendingRequests.length > 0) {
          let requestsHTML = '<table><tr><th>å¡ç‰‡UID</th><th>è²·å®¶åœ°å€</th><th>é‡‘é¡</th><th>è«‹æ±‚æ™‚é–“</th><th>æ“ä½œ</th></tr>';

          for (const request of pendingRequests) {
            // é¡¯ç¤ºUIDçš„å‰10ä½å’Œå¾Œ6ä½
            const shortUID = `${request.uid.slice(0, 10)}...${request.uid.slice(-6)}`;

            // å°‡æ™‚é–“æˆ³è½‰æ›ç‚ºæ—¥æœŸ
            const date = new Date(request.timestamp * 1000);
            const formattedDate = date.toLocaleString();

            // å°‡é‡‘é¡è½‰æ›ç‚ºETH
            const amount = ethers.utils.formatEther(request.amount);

            requestsHTML += `
          <tr>
            <td title="${request.uid}">${shortUID}</td>
            <td>${request.buyer}</td>
            <td>${amount} ETH</td>
            <td>${formattedDate}</td>
            <td>
              <button onclick="approveTransfer('${request.uid}')">æ‰¹å‡†</button>
              <button onclick="rejectTransfer('${request.uid}')">æ‹’çµ•</button>
            </td>
          </tr>
        `;
          }

          requestsHTML += '</table>';
          pendingDiv.innerHTML = requestsHTML;
        } else {
          pendingDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰å¾…è™•ç†çš„è«‹æ±‚ã€‚</p>';
        }
      } catch (error) {
        console.error("è¼‰å…¥å¾…è™•ç†è«‹æ±‚å¤±æ•—:", error);
        document.getElementById('pending-requests').innerHTML = `<p class="error">è¼‰å…¥å¾…è™•ç†è«‹æ±‚å¤±æ•—: ${error.message}</p>`;
      }
    }

    // æ·»åŠ æ‹’çµ•è½‰ç§»çš„å‡½æ•¸
    async function rejectTransfer(uid) {
      if (!isOwner) {
        alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
        return;
      }

      try {
        await contract.rejectTransfer(uid);
        alert('å·²æ‹’çµ•æ­¤è«‹æ±‚ï¼');

        // é‡æ–°è¼‰å…¥å¾…è™•ç†è«‹æ±‚
        loadPendingRequests();
      } catch (error) {
        console.error("æ‹’çµ•è«‹æ±‚å¤±æ•—:", error);
        alert('æ‹’çµ•è«‹æ±‚å¤±æ•—ï¼š' + error.message);
      }
    }

    // æ·»åŠ åˆ°windowå°è±¡
    window.rejectTransfer = rejectTransfer;

    // è³¼è²·å¡ç‰‡
    // async function purchaseCard() {
    //   try {
    //     const priceWei = await contract.getCardPrice();
    //     const purchaseStatus = document.getElementById('purchase-status');

    //     purchaseStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
    //     purchaseStatus.className = 'status info';

    //     await contract.purchaseSpecificCard({ value: priceWei });

    //     purchaseStatus.textContent = 'è³¼è²·æˆåŠŸï¼ç¾åœ¨æ‚¨å¯ä»¥ç¶å®šå¡ç‰‡ UIDã€‚';
    //     purchaseStatus.className = 'status success';
    //   } catch (error) {
    //     console.error("è³¼è²·å¡ç‰‡å¤±æ•—:", error);
    //     document.getElementById('purchase-status').textContent = 'è³¼è²·å¡ç‰‡å¤±æ•—ã€‚';
    //     document.getElementById('purchase-status').className = 'status error';
    //   }
    // }

    // async function bindCard() {
    //   const uid = document.getElementById('card-uid').value.trim();
    //   const requestStatus = document.getElementById('request-status');

    //   if (!uid) {
    //     requestStatus.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„å¡ç‰‡ UIDã€‚';
    //     requestStatus.className = 'status error';
    //     return;
    //   }

    //   try {
    //     // å¾é é¢å–å¾—å·²é€£æ¥éŒ¢åŒ…åœ°å€ (å‡è¨­ connectionStatus æ˜¯è©²å…ƒç´ ID)
    //     const connectionStatus = document.getElementById('connection-status');
    //     if (!connectionStatus || !connectionStatus.textContent) {
    //       requestStatus.innerHTML = `<div class="status error">æ‰¾ä¸åˆ°å·²é€£æ¥éŒ¢åŒ…åœ°å€ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</div>`;
    //       requestStatus.className = 'status error';
    //       return;
    //     }
    //     const prefix = 'å·²é€£æ¥åˆ°éŒ¢åŒ…ï¼š';
    //     let signerAddress = connectionStatus.textContent.trim();
    //     if (signerAddress.startsWith(prefix)) {
    //       signerAddress = signerAddress.slice(prefix.length).trim();
    //     }

    //     // ç°¡å–®é©—è­‰åœ°å€æ ¼å¼ï¼ˆå¯æ”¹ç”¨ ethers.utils.isAddressï¼‰
    //     if (!ethers.utils.isAddress(signerAddress)) {
    //       requestStatus.innerHTML = `<div class="status error">éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤: ${signerAddress}</div>`;
    //       requestStatus.className = 'status error';
    //       return;
    //     }
    //     requestStatus.innerHTML = '<span>ç¶å®šä¸­... <div class="loader"></div></span>';
    //     requestStatus.className = 'status info';

    //     // å‘¼å«ä¸»ç¨‹å¼åˆç´„bindCardUID
    //     const tx = await contract.bindCardUID(uid, signerAddress);
    //     await tx.wait();

    //     requestStatus.textContent = 'ç¶å®šæˆåŠŸï¼æ‚¨çš„å¡ç‰‡å·²å®Œæˆç¶å®šã€‚';
    //     requestStatus.className = 'status success';
    //   } catch (error) {
    //     console.error("ç¶å®šå¡ç‰‡å¤±æ•—:", error);
    //     let errorMessage = error.message.replace('execution reverted: ', '');
    //     requestStatus.textContent = 'ç¶å®šå¡ç‰‡å¤±æ•—ï¼š' + errorMessage;
    //     requestStatus.className = 'status error';
    //   }
    // }

    async function createTrade(uid, price) {
      try {
        const tx = await contract.createTrade(uid, price);
        await tx.wait();

        alert("ä¸Šæ¶æˆåŠŸï¼");
        await loadAvailableTrades();  // ğŸ‘ˆ åŠ é€™ä¸€è¡Œ

      } catch (err) {
        console.error("å»ºç«‹äº¤æ˜“å¤±æ•—ï¼š", err);
        alert("å»ºç«‹äº¤æ˜“å¤±æ•—ï¼š" + (err?.error?.message || err.message));
      }
    }
    createTrade
    window.createTrade = createTrade;




    // è³¼è²·å¡ç‰‡ (å¸‚å ´äº¤æ˜“)
    async function buyCard(tradeId, price) {
      try {
        await contract.buyerSign(tradeId, { value: price });

        alert('è³¼è²·æˆåŠŸï¼ç­‰å¾…è³£å®¶ç¢ºèªè½‰ç§»ã€‚');

        // é‡æ–°è¼‰å…¥äº¤æ˜“åˆ—è¡¨
        loadAvailableTrades();
        loadMyTrades();
      } catch (error) {
        console.error("è³¼è²·å¤±æ•—:", error);
        alert('è³¼è²·å¤±æ•—ï¼š' + error.message.replace('execution reverted: ', ''));
      }
    }


    // è¨­ç½®å¡ç‰‡åƒ¹æ ¼ (åƒ…ç®¡ç†å“¡)
    async function setCardPrice() {
      if (!isOwner) {
        alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
        return;
      }

      const idolGroup = document.getElementById('idol-group').value.trim();
      const idolMember = document.getElementById('idol-member').value.trim();
      const cardNumber = document.getElementById('card-number').value.trim();
      const listPriceEth = document.getElementById('list-price').value;
      const photoURI = document.getElementById('photo-uri').value.trim();
      const newPriceEth = document.getElementById('new-price').value;
      const amount = document.getElementById('card-amount').value;
      const setPriceStatus = document.getElementById('set-price-status');

      if (!newPriceEth || !idolGroup || !idolMember || !cardNumber || !listPriceEth || !photoURI) {
        setPriceStatus.textContent = 'è«‹å®Œæ•´è¼¸å…¥æ‰€æœ‰æ¬„ä½ã€‚';
        setPriceStatus.className = 'status error';
        return;
      }

      try {
        setPriceStatus.innerHTML = '<span>è™•ç†ä¸­... <div class="loader"></div></span>';
        setPriceStatus.className = 'status info';

        const newPriceWei = ethers.utils.parseEther(newPriceEth);
        const listPriceWei = ethers.utils.parseEther(listPriceEth);

        const tx = await contract.setCardPrice(
          newPriceWei,
          idolGroup,
          idolMember,
          cardNumber,
          listPriceWei,
          photoURI,
          amount
        );

        await tx.wait();

        setPriceStatus.textContent = 'å¡ç‰‡è³‡è¨Šè¨­ç½®æˆåŠŸï¼';
        setPriceStatus.className = 'status success';
      } catch (error) {
        console.error("è¨­ç½®å¡ç‰‡è³‡è¨Šå¤±æ•—:", error);
        setPriceStatus.textContent = 'è¨­ç½®å¡ç‰‡è³‡è¨Šå¤±æ•—ï¼š' + error.message.replace('execution reverted: ', '');
        setPriceStatus.className = 'status error';
      }
    }


    // å¯©æ‰¹å¡ç‰‡è«‹æ±‚ (åƒ…ç®¡ç†å“¡)
    async function approveTransfer(uid) {
      if (!isOwner) {
        alert('åªæœ‰åˆç´„æ“æœ‰è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œã€‚');
        return;
      }

      try {
        await contract.approveTransfer(uid);

        alert('å¯©æ‰¹æˆåŠŸï¼');

        // é‡æ–°è¼‰å…¥å¾…è™•ç†è«‹æ±‚
        loadPendingRequests();
      } catch (error) {
        console.error("å¯©æ‰¹å¤±æ•—:", error);
        alert('å¯©æ‰¹å¤±æ•—ï¼š' + error.message.replace('execution reverted: ', ''));
      }
    }

    // åˆå§‹åŒ–æ¨™ç±¤é åˆ‡æ›
    function initTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // ç§»é™¤æ‰€æœ‰æ¨™ç±¤é çš„ active é¡
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(tc => tc.classList.remove('active'));

          // ç‚ºç•¶å‰æ¨™ç±¤é æ·»åŠ  active é¡
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      document.getElementById('request-card-btn').addEventListener('click', bindCard);
      document.getElementById('create-trade-btn').addEventListener('click', createTrade);
      document.getElementById('set-price-btn').addEventListener('click', setCardPrice);
    });

    // æŸ¥çœ‹å¡ç‰‡è©³æƒ…å‡½æ•¸
    window.viewCardDetails = async function (uid) {
      console.log("ğŸ” æŸ¥è©¢äº¤æ˜“ç´€éŒ„ for UID:", uid);
      console.log("ğŸ“ åˆç´„åœ°å€:", contract.address);
      console.log("ğŸ“ å‡½æ•¸æ˜¯å¦å­˜åœ¨:", typeof contract.getTradesByUID);
      const modal = document.getElementById('card-modal');
      const content = document.getElementById('card-modal-content');
      modal.style.display = 'flex';
      content.innerHTML = '<p>è¼‰å…¥ä¸­... <div class="loader"></div></p>';

      try {
        console.log("ğŸ” æŸ¥çœ‹å¡ç‰‡è©³æƒ…ï¼ŒUID:", uid);

        if (!contract) {
          content.innerHTML = '<p class="error">åˆç´„å°šæœªé€£æ¥ï¼Œè«‹å…ˆé€£æ¥éŒ¢åŒ…ã€‚</p>';
          return;
        }

        // å˜—è©¦ç›´æ¥å‘¼å« TradeManager çš„å‡½æ•¸
        console.log("ğŸš€ å‘¼å« getTradesByUID...");
        const trades = await contract.getTradesByUID(uid);
        console.log("âœ… æˆåŠŸå–å¾—äº¤æ˜“è³‡æ–™:", trades);

        if (!trades || trades.length === 0) {
          content.innerHTML = `
                <h3>å¡ç‰‡è©³æƒ…</h3>
                <p><strong>UID:</strong> ${uid}</p>
                <p>â—ï¸ æ­¤å¡ç‰‡å°šæœªæœ‰äº¤æ˜“ç´€éŒ„ã€‚</p>
                <p><em>æç¤ºï¼šå¦‚æœé€™æ˜¯å‰›è³¼è²·çš„å¡ç‰‡ï¼Œäº¤æ˜“ç´€éŒ„å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ‰æœƒå‡ºç¾ã€‚</em></p>
            `;
          return;
        }

        let html = `
            <h3>å¡ç‰‡äº¤æ˜“æ­·å²</h3>
            <p><strong>UID:</strong> ${uid}</p>
            <table>
                <tr><th>äº¤æ˜“ ID</th><th>è²·å®¶</th><th>è³£å®¶</th><th>åƒ¹æ ¼</th><th>ç‹€æ…‹</th><th>æ™‚é–“</th></tr>
        `;

        for (const trade of trades) {
          const buyer = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'â€”';
          const seller = trade.seller ? `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}` : 'â€”';
          const priceEth = ethers.utils.formatEther(trade.price);
          const time = trade.timestamp > 0 ? new Date(trade.timestamp * 1000).toLocaleString() : 'â€”';
          const statusText = getStatusLabel(trade.status);

          html += `<tr>
                <td>#${trade.tradeId}</td>
                <td>${buyer}</td>
                <td>${seller}</td>
                <td>${priceEth} ETH</td>
                <td>${statusText}</td>
                <td>${time}</td>
            </tr>`;
        }

        html += `</table>`;
        content.innerHTML = html;

      } catch (err) {
        console.error("âŒ è¼‰å…¥äº¤æ˜“è©³æƒ…å¤±æ•—:", err);
        content.innerHTML = `
            <h3>éŒ¯èª¤è©³æƒ…</h3>
            <p class="error">ç„¡æ³•å–å¾—äº¤æ˜“ç´€éŒ„</p>
            <details>
                <summary>æŠ€è¡“ç´°ç¯€</summary>
                <pre>${err.message}</pre>
            </details>
            <p><em>è«‹ç¢ºèªï¼š</em></p>
            <ul>
                <li>åˆç´„æ˜¯å¦æ­£ç¢ºéƒ¨ç½²</li>
                <li>UID æ˜¯å¦æ­£ç¢º</li>
                <li>æ˜¯å¦æœ‰æ¬Šé™å­˜å–æ­¤è³‡æ–™</li>
            </ul>
        `;
      }
    };

    // åŠ å…¥ getStatusLabel å‡½æ•¸
    function getStatusLabel(status) {
      switch (status) {
        case 0: return '<span class="trade-status status-created">å·²å‰µå»º</span>';
        case 1: return '<span class="trade-status status-buyer-signed">è²·å®¶å·²ç°½ç½²</span>';
        case 2: return '<span class="trade-status status-seller-signed">è³£å®¶å·²ç°½ç½²</span>';
        case 5: return '<span class="trade-status status-completed">å·²å®Œæˆ</span>';
        default: return `<span class="trade-status">ç‹€æ…‹ ${status}</span>`;
      }
    }
    let cardManagerContract;


    async function checkCardManagerOwner() {
      if (!contract || !userAccount) {
        console.log("åˆç´„æˆ–ç”¨æˆ¶å¸³è™Ÿå°šæœªåˆå§‹åŒ–");
        return;
      }

      try {
        // ä½ éƒ¨ç½²æ™‚çš„ CardManager åˆç´„åœ°å€ï¼ˆè«‹æ›¿æ›ç‚ºä½ è‡ªå·±çš„ï¼‰
        //const cardManagerAddress = "0xC8c6E4176C9a23e886A9BcCcb80ABCbc3C5c2D65";

        // CardManager çš„ç°¡æ˜“ ABIï¼ŒåªåŒ…å« owner å‡½æ•¸
        const cardManagerAbi = [
          "function owner() view returns (address)"
        ];


        // ä½¿ç”¨ç¾æœ‰ provider å’Œ signer
        const provider = contract.provider;
        const signer = provider.getSigner(userAccount);

        // å»ºç«‹ CardManager åˆç´„ç‰©ä»¶
        const cardManagerContract = new ethers.Contract(cardManagerAddress, cardManagerAbi, signer);

        // è®€å– CardManager çš„ owner
        const ownerAddress = await cardManagerContract.owner();
        console.log("CardManager åˆç´„æ“æœ‰è€…:", ownerAddress);
        console.log("ç›®å‰éŒ¢åŒ…åœ°å€:", userAccount);

        if (ownerAddress.toLowerCase() === userAccount.toLowerCase()) {
          console.log("ä½ æ˜¯ CardManager çš„æ“æœ‰è€…ï¼Œå¯ä»¥åŸ·è¡Œç®¡ç†æ“ä½œã€‚");
        } else {
          console.warn("ä½ ä¸æ˜¯ CardManager çš„æ“æœ‰è€…ï¼Œç®¡ç†æ“ä½œæœƒè¢«æ‹’çµ•ï¼");
        }
      } catch (error) {
        console.error("æª¢æŸ¥ CardManager æ“æœ‰è€…å¤±æ•—:", error);
      }
    }

    window.testGetResaleCards = async function () {
      const cards = await contract.getResaleCards();
      console.log("äºŒæ‰‹å¡ç‰‡ï¼š", cards);
    };




  </script>
  <div id="card-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div
      style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 700px; max-height: 80%; overflow-y: auto; position: relative;">
      <span id="card-modal-close"
        style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer;">&times;</span>
      <h2>å¡ç‰‡äº¤æ˜“è©³æƒ…</h2>
      <div id="card-modal-content">
        <p>è¼‰å…¥ä¸­...
        <div class="loader"></div>
        </p>
      </div>
    </div>
  </div>

</body>

</html>